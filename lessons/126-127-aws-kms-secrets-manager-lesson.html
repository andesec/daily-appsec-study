<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lessons 126-127 ‚Äì AWS KMS & Secrets Manager Masterclass</title>
    <link rel="stylesheet" href="appsec-theme.css" />
</head>
<body>
    <div class="container">
        <header class="card lesson-hero">
            <div class="card-header">Lessons 126 &amp; 127</div>
            <div class="card-body">
                <h1>üîê AWS KMS &amp; Secrets Manager Masterclass</h1>
                <p>
                    Build senior-level intuition for managing encryption keys, rotation workflows, and multi-tenant secrets in AWS.
                    This refreshed layout pairs concise guidance with interactive widgets so every concept can be rehearsed.
                </p>
                <div class="grid grid-3">
                    <div class="callout callout-info">Cloud-Native AppSec</div>
                    <div class="callout callout-success">SaaS / Multi-tenant</div>
                    <div class="callout callout-warning">Hands-on Labs Included</div>
                </div>
            </div>
        </header>

        <nav class="card lesson-nav">
            <div class="card-header">Lesson Map</div>
            <div class="card-body">
                <ol class="toc">
                    <li><a href="#section-1">1. Foundation</a></li>
                    <li><a href="#section-2">2. Intuitive Hook</a></li>
                    <li><a href="#section-3">3. Mental Model</a></li>
                    <li><a href="#section-4">4. Deep Explanation</a></li>
                    <li><a href="#section-5">5. Real-World Context</a></li>
                    <li><a href="#section-6">6. Common Weaknesses</a></li>
                    <li><a href="#section-7">7. Hands-On Implementation</a></li>
                    <li><a href="#section-8">8. Defense &amp; Mitigation</a></li>
                    <li><a href="#section-9">9. Incident Case Study</a></li>
                    <li><a href="#section-10">10. Threat Model</a></li>
                    <li><a href="#section-11">11. Compliance Mapping</a></li>
                </ol>
            </div>
        </nav>

        <main>
            <section class="card" id="section-1">
                <div class="card-header">1. Foundation</div>
                <div class="card-body">
                    <p>
                        AWS <strong>Key Management Service (KMS)</strong> supplies hardware-protected master keys and envelope
                        encryption, while <strong>AWS Secrets Manager</strong> stores and rotates sensitive values that applications
                        retrieve at runtime. Treat KMS as the cryptographic control plane and Secrets Manager as the
                        lifecycle manager for credentials, API tokens, and certificates.
                    </p>
                    <div class="grid grid-2">
                        <div>
                            <h4>KMS Highlights</h4>
                            <ul>
                                <li>Customer managed keys (CMKs) support custom key policies, grants, and encryption context.</li>
                                <li>Automatic annual key material rotation without changing key IDs.</li>
                                <li>FIPS 140-2 validated HSM-backed operations exposed via IAM-secured APIs.</li>
                            </ul>
                        </div>
                        <div>
                            <h4>Secrets Manager Highlights</h4>
                            <ul>
                                <li>Stores text or binary secrets up to 65 KB, encrypted with a chosen KMS key.</li>
                                <li>Versioning via staging labels (<code>AWSCURRENT</code>, <code>AWSPENDING</code>, <code>AWSPREVIOUS</code>).</li>
                                <li>Event-driven rotation orchestrated with AWS Lambda and CloudWatch Events/EventBridge.</li>
                            </ul>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Key Type</th>
                                    <th>Who Manages?</th>
                                    <th>Rotation</th>
                                    <th>Best Use</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Customer Managed</td>
                                    <td>Your security team</td>
                                    <td>Every 365 days (configurable)</td>
                                    <td>Tenant isolation, audit-ready workloads</td>
                                </tr>
                                <tr>
                                    <td>AWS Managed</td>
                                    <td>AWS service team</td>
                                    <td>~3 years (fixed)</td>
                                    <td>Baseline encryption for low-risk data</td>
                                </tr>
                                <tr>
                                    <td>AWS Owned</td>
                                    <td>AWS internal</td>
                                    <td>Undisclosed</td>
                                    <td>Opaque service internals; avoid for regulated data</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="callout callout-info">
                        <strong>Encryption Context:</strong> optional key-value metadata bound to ciphertext as authenticated data.
                        KMS enforces that the same context be provided on decrypt, enabling attribute-based access such as
                        <code>kms:EncryptionContext:tenant_id = ${aws:PrincipalTag/tenant_id}</code>.
                    </div>
                    <ul class="references">
                        <li><a href="https://docs.aws.amazon.com/kms/latest/developerguide/overview.html" target="_blank" rel="noopener">AWS KMS Developer Guide ‚Äì Overview</a></li>
                        <li><a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/intro.html" target="_blank" rel="noopener">AWS Secrets Manager User Guide ‚Äì Introduction</a></li>
                    </ul>
                    <div class="widget" id="section-1-quiz"></div>
                </div>
            </section>

            <section class="card" id="section-2">
                <div class="card-header">2. Intuitive Hook</div>
                <div class="card-body">
                    <p>
                        Picture a hotel room safe. The master vault (KMS) issues a temporary combination (data key), you lock
                        valuables in the room (application data), then store the sealed combination in the concierge ledger
                        (Secrets Manager). Anyone who tries to open the safe later must present the exact room number and
                        reservation code (encryption context) or the vault refuses to help.
                    </p>
                    <div class="callout callout-success">
                        <strong>Why the analogy matters:</strong> It captures envelope encryption (delegating data encryption to
                        short-lived data keys) and the fact that Secrets Manager is the concierge service that distributes and
                        rotates combinations securely.
                    </div>
                    <div class="widget" id="envelope-flow"></div>
                    <p>
                        Secrets Manager also acts like a concierge hotline: it verifies your identity (IAM), checks you are in the
                        right room (encryption context), and only then whispers today‚Äôs combination (latest secret version).
                    </p>
                    <ul class="references">
                        <li><a href="https://aws.amazon.com/blogs/security/how-encryption-works-with-aws-kms/" target="_blank" rel="noopener">AWS Security Blog ‚Äì How Encryption Works with AWS KMS</a></li>
                        <li><a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/rotating-secrets.html" target="_blank" rel="noopener">Secrets Manager ‚Äì Rotating Secrets</a></li>
                    </ul>
                    <div class="widget" id="section-2-quiz"></div>
                </div>
            </section>

            <section class="card" id="section-3">
                <div class="card-header">3. Mental Model</div>
                <div class="card-body">
                    <p>
                        Anchor your reasoning on a SaaS platform with hundreds of tenants, each owning a database and
                        secrets portfolio. The healthy baseline pairs customer-managed KMS keys, strict IAM roles, encryption
                        context that embeds tenant IDs, and rotation Lambdas that report to observability pipelines.
                    </p>
                    <div class="grid grid-2">
                        <div>
                            <h4>Signals of a Mature Setup</h4>
                            <ul>
                                <li>Secrets are fetched at startup or on-demand and cached in memory with minimal TTL.</li>
                                <li>CloudTrail plus GuardDuty watch for anomalous decrypt or GetSecretValue spikes.</li>
                                <li>Downtime-free rotation because staging labels keep old values until deployments finish.</li>
                            </ul>
                        </div>
                        <div>
                            <h4>Failure Smells</h4>
                            <ul>
                                <li>Shared AWS managed keys that prevent tenant isolation.</li>
                                <li>Secrets duplicated into environment variables or baked into container images.</li>
                                <li>Rotation scripts that require manual approvals or have no rollback tests.</li>
                            </ul>
                        </div>
                    </div>
                    <div class="widget" id="section-3-progress"></div>
                    <ul class="references">
                        <li><a href="https://docs.aws.amazon.com/whitepapers/latest/aws-saas-factory-building-multi-tenant-solutions/tenant-isolation.html" target="_blank" rel="noopener">AWS SaaS Factory ‚Äì Tenant Isolation Strategies</a></li>
                        <li><a href="https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/security-pillar.html" target="_blank" rel="noopener">AWS Well-Architected Security Pillar</a></li>
                    </ul>
                    <div class="widget" id="section-3-quiz"></div>
                </div>
            </section>

            <section class="card" id="section-4">
                <div class="card-header">4. Deep Explanation</div>
                <div class="card-body">
                    <p>
                        Deep dive into envelope encryption, IAM policy design, and the four-step rotation contract. Use
                        encryption context to bind ciphertext to a tenant, and ensure rotation functions authenticate to the
                        target system before promoting new credentials.
                    </p>
                    <div class="callout callout-warning">
                        <strong>Envelope Encryption Mechanics</strong>
                        <ol>
                            <li>Application asks KMS for a data key via <code>GenerateDataKey</code>.</li>
                            <li>KMS returns plaintext + ciphertext data key; plaintext is used immediately, then discarded.</li>
                            <li>The ciphertext data key is stored with the encrypted payload so it can be decrypted later.</li>
                        </ol>
                    </div>
                    <pre><code>import boto3, json
kms = boto3.client('kms')
secrets = boto3.client('secretsmanager')

context = {"tenant_id": "acme", "environment": "prod"}
plaintext = json.dumps({"username": "service", "password": "P@ssw0rd!"})

resp = kms.encrypt(KeyId='alias/app-prod-master', Plaintext=plaintext.encode(), EncryptionContext=context)
secrets.put_secret_value(SecretId='prod/db/acme/master', SecretBinary=resp['CiphertextBlob'])</code></pre>
                    <p>Secrets Manager decrypts by presenting the same context back to KMS before handing plaintext to callers.</p>
                    <div class="widget" id="rotation-flow"></div>
                    <ul class="references">
                        <li><a href="https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#enveloping" target="_blank" rel="noopener">AWS KMS ‚Äì Envelope Encryption</a></li>
                        <li><a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/rotating-secrets_lamda-rds-rotation-single-user.html" target="_blank" rel="noopener">Secrets Manager ‚Äì Rotation Lambda Patterns</a></li>
                    </ul>
                    <div class="widget" id="section-4-quiz"></div>
                </div>
            </section>

            <section class="card" id="section-5">
                <div class="card-header">5. Real-World Context</div>
                <div class="card-body">
                    <p>
                        A representative SaaS control plane uses ECS tasks, AWS PrivateLink, and RDS clusters. Secrets Manager
                        stores tenant database credentials encrypted with tenant-specific CMKs, and EventBridge triggers the
                        rotation Lambda. Observability systems watch CloudTrail, CloudWatch Logs, and guardrails enforced via
                        Service Control Policies (SCPs).
                    </p>
                    <pre><code>Clients ‚îÄ‚ñ∂ API Gateway ‚îÄ‚ñ∂ ALB ‚îÄ‚ñ∂ ECS Service (per region)
                       ‚îÇ               ‚îÇ
                       ‚îÇ               ‚îú‚îÄ‚ñ∂ Secrets Manager (VPC endpoint)
                       ‚îÇ               ‚îÇ        ‚îî‚îÄ‚ñ∂ AWS KMS (tenant CMKs)
                       ‚îÇ               ‚îî‚îÄ‚ñ∂ RDS (per-tenant cluster)
                       ‚îî‚îÄ‚ñ∂ Audit Stack (CloudTrail + GuardDuty + SIEM)</code></pre>
                    <div class="callout callout-success">
                        <strong>Operational checklist:</strong>
                        <ul>
                            <li>Include tenant/environment tags in both IAM roles and encryption context.</li>
                            <li>Throttle GetSecretValue with exponential backoff; cache per tenant for 5‚Äì10 minutes.</li>
                            <li>Alert on rotation Lambda failures and ensure <code>AWSPREVIOUS</code> exists until deployment completes.</li>
                        </ul>
                    </div>
                    <div class="widget" id="section-5-flow"></div>
                    <ul class="references">
                        <li><a href="https://aws.amazon.com/blogs/security/how-to-rotate-database-credentials-securely-with-secrets-manager/" target="_blank" rel="noopener">AWS Security Blog ‚Äì Rotate Database Credentials Securely</a></li>
                        <li><a href="https://d1.awsstatic.com/whitepapers/aws-overview.pdf" target="_blank" rel="noopener">AWS Overview of Security Processes</a></li>
                    </ul>
                    <div class="widget" id="section-5-quiz"></div>
                </div>
            </section>

            <section class="card" id="section-6">
                <div class="card-header">6. Common Weaknesses &amp; Attack Paths</div>
                <div class="card-body">
                    <p>Red-team these three recurring mistakes to test the resilience of your implementation.</p>
                    <h4>Attack Path 1 ‚Äì Encryption Context Bypass</h4>
                    <div class="widget" id="attack1-flow"></div>
                    <div class="widget" id="attack1-defense"></div>
                    <h4>Attack Path 2 ‚Äì AWS Managed Key Downgrade</h4>
                    <div class="widget" id="attack2-flow"></div>
                    <div class="widget" id="attack2-defense"></div>
                    <h4>Attack Path 3 ‚Äì Rotation Lambda Compromise</h4>
                    <div class="widget" id="attack3-flow"></div>
                    <div class="widget" id="attack3-defense"></div>
                    <div class="callout callout-danger">
                        <strong>Detection Tips:</strong> feed CloudTrail events into GuardDuty, flag GetSecretValue bursts,
                        require IMDSv2 to prevent SSRF-driven credential theft, and isolate rotation Lambdas in private subnets
                        with egress only to target databases and AWS endpoints.
                    </div>
                    <ul class="references">
                        <li><a href="https://docs.aws.amazon.com/kms/latest/developerguide/key-policies.html" target="_blank" rel="noopener">AWS KMS ‚Äì Key Policy Best Practices</a></li>
                        <li><a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/security.html" target="_blank" rel="noopener">Secrets Manager ‚Äì Security Considerations</a></li>
                    </ul>
                    <div class="widget" id="section-6-quiz"></div>
                </div>
            </section>

            <section class="card" id="section-7">
                <div class="card-header">7. Hands-On Implementation</div>
                <div class="card-body">
                    <p>Use the following sandbox-ready lab to rehearse the entire lifecycle.</p>
                    <div class="widget" id="lab-flow"></div>
                    <div class="grid grid-2">
                        <div>
                            <h4>Terraform Snippet</h4>
                            <pre><code>resource "aws_kms_key" "tenant" {
  description = "Tenant CMK"
  deletion_window_in_days = 30
}

resource "aws_secretsmanager_secret" "db_master" {
  name       = "prod/db/acme/master"
  kms_key_id = aws_kms_key.tenant.arn
}</code></pre>
                        </div>
                        <div>
                            <h4>Rotation Lambda Checklist</h4>
                            <ul>
                                <li>Implements <code>createSecret</code>, <code>setSecret</code>, <code>testSecret</code>, <code>finishSecret</code>.</li>
                                <li>Uses Secrets Manager VPC endpoint plus security group egress limited to RDS + Secrets Manager.</li>
                                <li>Publishes structured logs with secret ARN (non-sensitive) and rotation status.</li>
                            </ul>
                        </div>
                    </div>
                    <ul class="references">
                        <li><a href="https://catalog.workshops.aws/secrets-manager-and-kms/en-US" target="_blank" rel="noopener">AWS Workshop ‚Äì Secrets Manager &amp; KMS</a></li>
                        <li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/secretsmanager_secret" target="_blank" rel="noopener">Terraform AWS Provider ‚Äì Secrets Manager</a></li>
                    </ul>
                    <div class="widget" id="section-7-quiz"></div>
                </div>
            </section>

            <section class="card" id="section-8">
                <div class="card-header">8. Defense &amp; Mitigation</div>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Threat</th>
                                    <th>Preventive Control</th>
                                    <th>Detection</th>
                                    <th>Resilience</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>SSRF steals IAM role credentials</td>
                                    <td>Enforce IMDSv2, scoped IAM roles, encryption context</td>
                                    <td>GuardDuty finding <em>CredentialAccess:IAMUser/InstanceCredentialExfiltration</em></td>
                                    <td>Short TTL secrets + <code>AWSPREVIOUS</code> rollback</td>
                                </tr>
                                <tr>
                                    <td>Misused AWS managed key</td>
                                    <td>SCP denies Secrets Manager calls without CMK ARN</td>
                                    <td>Config evaluation (AWS Config) for key ID drift</td>
                                    <td>Automated remediation pipeline to recreate secrets</td>
                                </tr>
                                <tr>
                                    <td>Rotation Lambda exfiltrates secrets</td>
                                    <td>Private subnets, no outbound internet, pin dependencies</td>
                                    <td>VPC Flow Logs + CloudWatch anomaly alerts on egress</td>
                                    <td>Break-glass manual rotation runbook</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="widget" id="mitigation-config-diff"></div>
                    <ul class="references">
                        <li><a href="https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples.html" target="_blank" rel="noopener">AWS Organizations ‚Äì SCP Examples</a></li>
                        <li><a href="https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-controls-reference.html" target="_blank" rel="noopener">AWS Security Hub Controls Reference</a></li>
                    </ul>
                    <div class="widget" id="section-8-quiz"></div>
                </div>
            </section>

            <section class="card" id="section-9">
                <div class="card-header">9. Incident Case Study ‚Äì Capital One (2019)</div>
                <div class="card-body">
                    <p>
                        A former AWS employee exploited a SSRF flaw in Capital One's WAF to query the EC2 metadata service,
                        harvested IAM role credentials, enumerated S3 buckets, and decrypted data protected by KMS because
                        the key policy trusted the compromised role. 100M+ credit card applications were exposed.
                    </p>
                    <pre><code>Internet ‚îÄ‚ñ∂ Misconfigured WAF ‚îÄ‚ñ∂ EC2 Instance (metadata service accessible)
                                   ‚îÇ
                                   ‚îú‚îÄ‚ñ∂ sts:GetCallerIdentity
                                   ‚îú‚îÄ‚ñ∂ s3:ListBuckets + GetObject
                                   ‚îî‚îÄ‚ñ∂ kms:Decrypt (no encryption context conditions)</code></pre>
                    <div class="callout callout-danger">
                        <ul>
                            <li><strong>Root cause:</strong> SSRF allowed metadata access and role credentials lacked scoped policies.</li>
                            <li><strong>Detection:</strong> CloudTrail showed unusual <code>ListBuckets</code>; external researchers spotted data on GitHub.</li>
                            <li><strong>Remediation:</strong> Hardened WAF rules, enabled IMDSv2, added encryption context conditions, and accelerated secret rotation.</li>
                        </ul>
                    </div>
                    <div class="widget" id="incident-flow"></div>
                    <ul class="references">
                        <li><a href="https://www.justice.gov/usao-wdwa/pr/former-seattle-tech-worker-pleads-guilty-wire-fraud-and-computer-intrusion" target="_blank" rel="noopener">US DOJ ‚Äì Capital One Breach Plea Agreement</a></li>
                        <li><a href="https://www.capitalone.com/facts2019/" target="_blank" rel="noopener">Capital One ‚Äì 2019 Cyber Incident Update</a></li>
                    </ul>
                    <div class="widget" id="section-9-quiz"></div>
                </div>
            </section>

            <section class="card" id="section-10">
                <div class="card-header">10. Threat Model</div>
                <div class="card-body">
                    <p>Model the shared secrets platform as a system boundary with distinct actors and trust zones.</p>
                    <pre><code> [Developers] ‚îÄ‚ñ∂ [CI/CD] ‚îÄ‚ñ∂ [ECS Tasks]
                                ‚îÇ
                                ‚îú‚îÄ‚ñ∂ [Secrets Manager VPC Endpoint]
                                ‚îÇ        ‚îî‚îÄ‚ñ∂ [AWS KMS CMKs]
                                ‚îî‚îÄ‚ñ∂ [Tenant Databases]
 Trusted AWS Control Plane  ‚îÇ  Application VPC  ‚îÇ  Data Plane
</code></pre>
                    <ul>
                        <li><strong>Spoofing:</strong> Compromised IAM role tokens.</li>
                        <li><strong>Tampering:</strong> Modified rotation Lambda packages.</li>
                        <li><strong>Repudiation:</strong> Missing CloudTrail / CloudWatch retention.</li>
                        <li><strong>Information Disclosure:</strong> Excessive GetSecretValue permissions.</li>
                        <li><strong>Denial of Service:</strong> KMS API throttling or region outage.</li>
                        <li><strong>Elevation of Privilege:</strong> Overly broad key policies with <code>kms:* </code>.</li>
                    </ul>
                    <div class="widget" id="threat-model-widget"></div>
                    <ul class="references">
                        <li><a href="https://learn.microsoft.com/en-us/azure/security/develop/threat-modeling-tool-threats" target="_blank" rel="noopener">STRIDE Threat Modeling Guidance</a></li>
                        <li><a href="https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/sec_threat-modeling.html" target="_blank" rel="noopener">AWS Well-Architected ‚Äì Threat Modeling</a></li>
                    </ul>
                    <div class="widget" id="section-10-quiz"></div>
                </div>
            </section>

            <section class="card" id="section-11">
                <div class="card-header">11. Compliance Mapping</div>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Framework</th>
                                    <th>Relevant Clauses</th>
                                    <th>How KMS + Secrets Manager Helps</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>ISO/IEC 27001</td>
                                    <td>A.8, A.10 ‚Äì Cryptographic controls</td>
                                    <td>CMKs with documented policies satisfy key management inventory and segregation of duties.</td>
                                </tr>
                                <tr>
                                    <td>NIST 800-53</td>
                                    <td>SC-12, SC-13, AC-6</td>
                                    <td>Automated key establishment and least privilege IAM roles align with SC and AC families.</td>
                                </tr>
                                <tr>
                                    <td>PCI DSS</td>
                                    <td>Req. 3 &amp; 8</td>
                                    <td>Secrets Manager rotation enforces unique credentials and protects cardholder data encryption keys.</td>
                                </tr>
                                <tr>
                                    <td>HIPAA</td>
                                    <td>164.312(a)(2)(iv)</td>
                                    <td>Key escrow, access logging, and encryption meet technical safeguard requirements.</td>
                                </tr>
                                <tr>
                                    <td>GDPR</td>
                                    <td>Art. 32</td>
                                    <td>Demonstrates appropriate technical measures for pseudonymisation and access control.</td>
                                </tr>
                                <tr>
                                    <td>SOC 2</td>
                                    <td>CC6.x, CC7.x</td>
                                    <td>Secrets inventory, rotation evidence, and CloudTrail logs support control assertions.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p>
                        When a framework does not explicitly mention cloud-native services (e.g., SOC 2), document how KMS key
                        policies, rotation evidence, and IAM guardrails implement the principle in your control narrative.
                    </p>
                    <ul class="references">
                        <li><a href="https://aws.amazon.com/compliance/programs/" target="_blank" rel="noopener">AWS Compliance Programs</a></li>
                        <li><a href="https://www.pcisecuritystandards.org/document_library" target="_blank" rel="noopener">PCI SSC Document Library</a></li>
                    </ul>
                    <div class="widget" id="section-11-quiz"></div>
                </div>
            </section>
        </main>

        <footer class="card lesson-footer">
            <div class="card-header">Lesson Recap</div>
            <div class="card-body">
                <p>
                    Blend automation (Secrets Manager rotation, IAM condition keys), observability (CloudTrail, GuardDuty, Security Hub),
                    and resilience (rollback-ready staging labels) to keep keys and secrets trustworthy. Rehearse the provided lab,
                    revisit the threat model as the architecture evolves, and link evidence artifacts to your compliance statements.
                </p>
            </div>
        </footer>
    </div>

    <script src="appsec-theme.js"></script>
    <script src="appsec-widgets.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            AppSecWidgets.FlowVisualizer.create('envelope-flow', {
                title: 'Envelope Encryption Walkthrough',
                steps: [
                    { title: '1Ô∏è‚É£ Request data key', description: 'Application calls GenerateDataKey on a tenant CMK.' },
                    { title: '2Ô∏è‚É£ Encrypt data locally', description: 'Plaintext data key encrypts application secrets or files.' },
                    { title: '3Ô∏è‚É£ Store encrypted key', description: 'Ciphertext data key is stored alongside encrypted payload.' },
                    { title: '4Ô∏è‚É£ Decrypt later', description: 'Secrets Manager replays kms:Decrypt with the same context before returning plaintext.' }
                ]
            });

            AppSecWidgets.ProgressTracker.create('section-3-progress', {
                title: 'Operational Health Indicators',
                categories: [
                    { icon: 'üîè', name: 'Confidentiality', progress: 85, items: [
                        { name: 'CMKs per tenant', completed: true },
                        { name: 'Encryption context enforcement', completed: true },
                        { name: 'Secrets cached securely', completed: false }
                    ] },
                    { icon: 'üõ†Ô∏è', name: 'Integrity', progress: 70, items: [
                        { name: 'Rotation Lambda tests', completed: true },
                        { name: 'Dependency pinning', completed: false }
                    ] },
                    { icon: 'ü©∫', name: 'Availability', progress: 65, items: [
                        { name: 'Multi-AZ CMKs', completed: true },
                        { name: 'Decryption rate-limit handling', completed: false }
                    ] }
                ]
            });

            AppSecWidgets.FlowVisualizer.create('rotation-flow', {
                title: 'Secrets Manager Rotation Contract',
                steps: [
                    { title: 'createSecret', description: 'Generate new password and store as AWSPENDING.' },
                    { title: 'setSecret', description: 'Update downstream system (e.g., RDS) using AWSCURRENT credentials.' },
                    { title: 'testSecret', description: 'Validate connectivity with the pending secret value.' },
                    { title: 'finishSecret', description: 'Promote AWSPENDING to AWSCURRENT and demote previous version.' }
                ]
            });

            AppSecWidgets.FlowVisualizer.create('section-5-flow', {
                title: 'Cross-Service Flow',
                steps: [
                    { title: 'API call arrives', description: 'API Gateway invokes ECS task with tenant context.' },
                    { title: 'Secret retrieval', description: 'Task calls Secrets Manager via VPC endpoint.' },
                    { title: 'KMS decrypt', description: 'Secrets Manager decrypts secret with tenant CMK + context.' },
                    { title: 'Database connection', description: 'ECS task connects to tenant RDS using retrieved credentials.' }
                ]
            });

            AppSecWidgets.FlowVisualizer.create('attack1-flow', {
                title: 'Encryption Context Bypass',
                steps: [
                    { title: 'Exploit SSRF', description: 'Abuse metadata service to steal IAM role creds.' },
                    { title: 'Enumerate secrets', description: 'Call ListSecrets / GetSecretValue for other tenants.' },
                    { title: 'Decrypt data', description: 'Without context enforcement, kms:Decrypt succeeds everywhere.' }
                ]
            });

            AppSecWidgets.AttackDefense.create('attack1-defense', 'Tenant-Bound Ciphertexts', `
                <h4>Attack Notes</h4>
                <ul>
                    <li>Credentials stolen via SSRF or leaked instance profile.</li>
                    <li>Role missing encryption context condition so kms:Decrypt works globally.</li>
                    <li>Attacker scripts GetSecretValue to dump all tenants within minutes.</li>
                </ul>
            `, `
                <h4>Defense Patterns</h4>
                <ul>
                    <li>Key policy condition: <code>\${aws:PrincipalTag/tenant_id}</code> must match encryption context.</li>
                    <li>GuardDuty alert on unusual GetSecretValue bursts.</li>
                    <li>Enable IMDSv2 and block metadata IPs at ALB/WAF layer.</li>
                </ul>
            `);

            AppSecWidgets.FlowVisualizer.create('attack2-flow', {
                title: 'AWS Managed Key Downgrade',
                steps: [
                    { title: 'Secret created quickly', description: 'Developer omits --kms-key-id (defaults to aws/secretsmanager).' },
                    { title: 'No custom policy', description: 'Cannot enforce tenant tags or cross-account restrictions.' },
                    { title: 'Credential reuse', description: 'Any role with GetSecretValue retrieves all sensitive data.' }
                ]
            });

            AppSecWidgets.AttackDefense.create('attack2-defense', 'Mandate Customer Keys', `
                <h4>Attack Notes</h4>
                <p>Downgrading to the AWS managed key removes encryption-context checks and complicates revocation. Attackers only need one mis-scoped IAM permission.</p>
            `, `
                <h4>Defense Patterns</h4>
                <ul>
                    <li>Service Control Policy denying Secrets Manager calls without CMK ARN.</li>
                    <li>AWS Config rule: secret must reference approved CMK alias.</li>
                    <li>Break-glass manual review before allowing AWS managed keys.</li>
                </ul>
            `);

            AppSecWidgets.FlowVisualizer.create('attack3-flow', {
                title: 'Rotation Lambda Compromise',
                steps: [
                    { title: 'Dependency drift', description: 'Lambda bundle pulls vulnerable dependency with RCE.' },
                    { title: 'Malicious update', description: 'Attacker modifies rotation logic to exfiltrate secrets.' },
                    { title: 'Silent persistence', description: 'Each rotation leaks new credentials outward.' }
                ]
            });

            AppSecWidgets.AttackDefense.create('attack3-defense', 'Secure Rotation Functions', `
                <h4>Attack Notes</h4>
                <ul>
                    <li>Lambda allowed outbound internet, so exfiltration over HTTPS went unnoticed.</li>
                    <li>No code signing or dependency pinning required for deployment.</li>
                </ul>
            `, `
                <h4>Defense Patterns</h4>
                <ul>
                    <li>Use private subnets + VPC endpoints; no egress to the internet.</li>
                    <li>Enforce Lambda code signing and Software Bill of Materials (SBOM) checks.</li>
                    <li>Enable CloudTrail <code>PutFunctionCode</code> alerts.</li>
                </ul>
            `);

            AppSecWidgets.FlowVisualizer.create('lab-flow', {
                title: 'Lab Execution Plan',
                steps: [
                    { title: 'Provision CMK', description: 'Create tenant-tagged CMK with key policy conditions.' },
                    { title: 'Create secret', description: 'Store DB creds referencing CMK, seed AWSCURRENT version.' },
                    { title: 'Deploy rotation Lambda', description: 'Attach least-privilege role + VPC endpoint access.' },
                    { title: 'Trigger rotation', description: 'Use CLI or console to force rotation and inspect staging labels.' },
                    { title: 'Observe telemetry', description: 'Review CloudWatch Logs + CloudTrail events for each step.' }
                ]
            });

            AppSecWidgets.ConfigDiff.create('mitigation-config-diff', 'SCP ‚Äì Require CMKs', `
                {
                  "Version": "2012-10-17",
                  "Statement": [{
                    "Effect": "Deny",
                    "Action": ["secretsmanager:CreateSecret", "secretsmanager:PutSecretValue"],
                    "Resource": "*",
                    "Condition": {"StringNotLike": {"secretsmanager:KmsKeyId": "arn:aws:kms:*:*:key/*"}}
                  }]
                }
            `, `
                {
                  "Version": "2012-10-17",
                  "Statement": [{
                    "Effect": "Deny",
                    "Action": ["secretsmanager:CreateSecret", "secretsmanager:PutSecretValue"],
                    "Resource": "*",
                    "Condition": {"StringNotEquals": {"secretsmanager:KmsKeyId": "arn:aws:kms:us-east-1:123456789012:key/tenant-*"}}
                  }]
                }
            `);

            AppSecWidgets.FlowVisualizer.create('incident-flow', {
                title: 'Capital One Attack Timeline',
                steps: [
                    { title: '1. SSRF', description: 'Web request hits misconfigured WAF and metadata service.' },
                    { title: '2. Credential theft', description: 'Temporary role credentials harvested from IMDS.' },
                    { title: '3. Data exfiltration', description: 'S3 + KMS APIs used from attacker infrastructure.' },
                    { title: '4. Detection', description: 'External researcher finds data; CloudTrail correlated after disclosure.' }
                ]
            });

            AppSecWidgets.ThreatModel.create('threat-model-widget', {
                system: {
                    name: 'Secrets Control Plane',
                    type: 'Multi-tenant SaaS',
                    actors: 'ECS tasks, rotation Lambdas, administrators',
                    assets: 'Tenant DB passwords, API tokens, CMKs',
                    entryPoints: 'Secrets Manager API, IAM roles, CI/CD pipeline',
                    boundaries: 'AWS account boundary + VPC network segments'
                },
                stride: {
                    spoofing: 'Stolen IAM tokens from metadata service',
                    tampering: 'Modified rotation package or Terraform state',
                    repudiation: 'Missing CloudTrail retention for kms:Decrypt',
                    information: 'GetSecretValue on all tenants without context',
                    dos: 'KMS throttle events or key deletion',
                    elevation: 'Key policy granting kms:* to wildcard principals'
                }
            }, { title: 'STRIDE Canvas ‚Äì Secrets Platform' });

            const quizData = {
                'section-1-quiz': {
                    title: 'Foundation Check',
                    questions: [
                        { text: 'Which service stores and versions credentials?', options: [
                            { value: 'kms', label: 'AWS KMS' },
                            { value: 'secrets', label: 'AWS Secrets Manager', correct: true },
                            { value: 'cloudtrail', label: 'AWS CloudTrail' }
                        ] },
                        { text: 'Why use encryption context?', options: [
                            { value: 'logging', label: 'To create CloudWatch alarms' },
                            { value: 'scope', label: 'To bind ciphertext to tenant or environment metadata', correct: true },
                            { value: 'performance', label: 'To speed up AES operations' }
                        ] }
                    ]
                },
                'section-2-quiz': {
                    title: 'Analogy Pulse Check',
                    questions: [
                        { text: 'In the hotel safe analogy, what does Secrets Manager represent?', options: [
                            { value: 'vault', label: 'Physical vault hardware' },
                            { value: 'concierge', label: 'Concierge that validates identity and hands out combinations', correct: true },
                            { value: 'hallway', label: 'Hallway camera feed' }
                        ] },
                        { text: 'What must match to decrypt data?', options: [
                            { value: 'kms-region', label: 'Only the AWS Region' },
                            { value: 'context', label: 'Encryption context supplied during encrypt/decrypt', correct: true },
                            { value: 'instance-type', label: 'EC2 instance type' }
                        ] }
                    ]
                },
                'section-3-quiz': {
                    title: 'Mental Model Quiz',
                    questions: [
                        { text: 'Which signal indicates unhealthy secrets hygiene?', options: [
                            { value: 'tenant-cmk', label: 'CMKs per tenant' },
                            { value: 'hardcoded', label: 'Credentials baked into container images', correct: true },
                            { value: 'context', label: 'Encryption context on every request' }
                        ] },
                        { text: 'Why keep rotation Lambdas observable?', options: [
                            { value: 'billing', label: 'To lower cost' },
                            { value: 'rollback', label: 'To detect failures before promoting new secrets', correct: true },
                            { value: 'dns', label: 'To manage Route53 zones' }
                        ] }
                    ]
                },
                'section-4-quiz': {
                    title: 'Mechanics Review',
                    questions: [
                        { text: 'What does GenerateDataKey return?', options: [
                            { value: 'arn', label: 'Only a key ARN' },
                            { value: 'both', label: 'Plaintext + ciphertext data key pair', correct: true },
                            { value: 'nothing', label: 'No output, it only logs events' }
                        ] },
                        { text: 'Which rotation step validates the new credential?', options: [
                            { value: 'create', label: 'createSecret' },
                            { value: 'test', label: 'testSecret', correct: true },
                            { value: 'finish', label: 'finishSecret' }
                        ] }
                    ]
                },
                'section-5-quiz': {
                    title: 'Architecture Check',
                    questions: [
                        { text: 'Why use VPC endpoints for Secrets Manager?', options: [
                            { value: 'cheaper', label: 'Lower data transfer cost only' },
                            { value: 'isolation', label: 'Keep traffic inside private subnets and avoid internet exposure', correct: true },
                            { value: 'dns', label: 'To skip Route53 registration' }
                        ] },
                        { text: 'How long should AWSPREVIOUS stay?', options: [
                            { value: 'minutes', label: 'Immediately deleted' },
                            { value: 'deploy', label: 'Retained until deployments confirm new secrets', correct: true },
                            { value: 'never', label: 'Never delete old secrets' }
                        ] }
                    ]
                },
                'section-6-quiz': {
                    title: 'Attack Surface Quiz',
                    questions: [
                        { text: 'What makes encryption-context bypass possible?', options: [
                            { value: 'scp', label: 'An SCP that requires CMKs' },
                            { value: 'missing-context', label: 'Key policies without context conditions', correct: true },
                            { value: 'tls', label: 'TLS termination at ALB' }
                        ] },
                        { text: 'How do you constrain rotation Lambdas?', options: [
                            { value: 'public', label: 'Deploy them in public subnets' },
                            { value: 'private', label: 'Place them in private subnets with restricted egress', correct: true },
                            { value: 'iam', label: 'Give them AdministratorAccess' }
                        ] }
                    ]
                },
                'section-7-quiz': {
                    title: 'Hands-On Quiz',
                    questions: [
                        { text: 'Which Terraform attribute ties a secret to a CMK?', options: [
                            { value: 'description', label: 'description' },
                            { value: 'kms-key', label: 'kms_key_id', correct: true },
                            { value: 'rotation', label: 'rotation_enabled' }
                        ] },
                        { text: 'Why include tenant tags on IAM roles?', options: [
                            { value: 'billing', label: 'To feed Cost Explorer' },
                            { value: 'abac', label: 'To support attribute-based access control in key policies', correct: true },
                            { value: 'dns', label: 'To manage Route53 records' }
                        ] }
                    ]
                },
                'section-8-quiz': {
                    title: 'Defense Quiz',
                    questions: [
                        { text: 'Which SCP condition blocks AWS managed keys?', options: [
                            { value: 'stringlike', label: 'StringNotLike secretsmanager:KmsKeyId to CMK ARNs', correct: true },
                            { value: 'numeric', label: 'NumericLessThan cost-center' },
                            { value: 'null', label: 'Null kms:ViaService' }
                        ] },
                        { text: 'What telemetry surfaces Lambda egress?', options: [
                            { value: 'flowlogs', label: 'VPC Flow Logs and CloudWatch metrics', correct: true },
                            { value: 'route53', label: 'Route53 query logging' },
                            { value: 'efs', label: 'EFS throughput graphs' }
                        ] }
                    ]
                },
                'section-9-quiz': {
                    title: 'Case Study Quiz',
                    questions: [
                        { text: 'Which flaw enabled the Capital One breach?', options: [
                            { value: 'waf', label: 'SSRF through a misconfigured WAF', correct: true },
                            { value: 'dns', label: 'Expired DNS records' },
                            { value: 'gke', label: 'Google Kubernetes Engine exploit' }
                        ] },
                        { text: 'What control would have limited blast radius?', options: [
                            { value: 'context', label: 'Key policies requiring tenant encryption context', correct: true },
                            { value: 'plaintext', label: 'Storing secrets in plaintext files' },
                            { value: 'ftp', label: 'Using FTP for backups' }
                        ] }
                    ]
                },
                'section-10-quiz': {
                    title: 'Threat Modeling Quiz',
                    questions: [
                        { text: 'Which STRIDE category covers missing CloudTrail logs?', options: [
                            { value: 'rep', label: 'Repudiation', correct: true },
                            { value: 'spoof', label: 'Spoofing' },
                            { value: 'dos', label: 'Denial of Service' }
                        ] },
                        { text: 'What is the boundary asset in this model?', options: [
                            { value: 'cmk', label: 'Secrets control plane with CMKs', correct: true },
                            { value: 'personal', label: 'Personal laptops' },
                            { value: 'cdn', label: 'Public CDN' }
                        ] }
                    ]
                },
                'section-11-quiz': {
                    title: 'Compliance Quiz',
                    questions: [
                        { text: 'PCI DSS requirement satisfied by rotation?', options: [
                            { value: 'req3', label: 'Requirement 3 (protect stored cardholder data)', correct: true },
                            { value: 'req1', label: 'Requirement 1 (firewall configuration)' },
                            { value: 'req12', label: 'Requirement 12 (policy)' }
                        ] },
                        { text: 'How does GDPR Art. 32 apply?', options: [
                            { value: 'measures', label: 'Demonstrate appropriate technical measures like key management', correct: true },
                            { value: 'marketing', label: 'Allow marketing emails' },
                            { value: 'tax', label: 'Handle tax withholding' }
                        ] }
                    ]
                }
            };

            Object.entries(quizData).forEach(([id, config]) => {
                if (document.getElementById(id)) {
                    AppSecWidgets.Quiz.create(id, config);
                }
            });
        });
    </script>
</body>
</html>
