<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Lesson 13: AWS Service Roles ‚Äì Workload Identity Guardrails</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <!-- Theme & Layout -->
    <link href="appsec-theme.css" rel="stylesheet" />
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="card">
            <div class="card-header">
                Lesson 13: AWS Service Roles ‚Äì Hardened Workload Identities Across AWS
            </div>
            <div class="card-body">
                <p>
                    This lesson teaches how IAM roles, trust policies, and AWS STS power modern workload identities. You
                    will move
                    from foundational concepts (Lambda execution roles, EC2 instance profiles, IMDSv2) to mental models,
                    real-world
                    architectures, incident history, and mitigation checklists so you can review AWS environments like a
                    principal
                    AppSec engineer.
                </p>
                <p>
                    Each contract section is delivered as a card, links to the shared AppSec theme and widget library,
                    and ends
                    with an interactive quiz so you can validate retention before moving forward.
                </p>
                <nav id="toc"></nav>
            </div>
        </header>
        <!-- Sections are injected by join_html_topics.py -->
        <!-- Footer -->
        <section class="card" id="section-1">
            <div class="card-header">1. Foundations</div>
            <div class="card-body">
                <p>
                    AWS Identity and Access Management (IAM) roles are <strong>temporary identities for
                        workloads</strong>. They have no
                    permanent credentials, are assumed via AWS Security Token Service (STS), and scope every Lambda,
                    EC2, ECS, EKS, Glue,
                    and Step Functions workload. This card frames the section; each numbered subsection dives deeper.
                </p>
            </div>
        </section>
        <section class="card" id="section-1-1">
            <div class="card-header">1.1 Understanding IAM Roles</div>
            <div class="card-body">
                <p>Core reasons roles are favored over IAM users for automation:</p>
                <ul>
                    <li>Eliminate long-lived access keys that leak through logs, repos, screenshots, or CI artifacts.
                    </li>
                    <li>Scope permissions per workload to enforce least privilege and contain compromises.</li>
                    <li>Rely on scoped trust policies to keep assumptions explicit.</li>
                    <li>Support cross-account automation and vendor integrations safely.</li>
                    <li>Allow credentials to expire automatically, preventing persistence.</li>
                </ul>
                <p>Roles power numerous services: Lambda execution, EC2 instance profiles, ECS task roles, EKS IRSA,
                    CloudFormation
                    service roles, CI/CD cross-account access, and federated access through OIDC/SAML. <a
                        href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html" rel="noopener"
                        target="_blank">AWS IAM role
                        guide ‚Üó</a></p>
            </div>
        </section>
        <section class="card" id="section-1-2">
            <div class="card-header">1.2 AWS STS: Identity Backbone</div>
            <div class="card-body">
                <p>
                    AWS STS issues short-lived credentials that inherit permission scope from the assumed role, use
                    session lifetimes of
                    15‚Äì60 minutes by default, and rotate automatically at expiration.
                </p>
                <ul>
                    <li><code>AssumeRole</code> ‚Äì used by Lambda, EC2, ECS, Step Functions, cross-account workflows.
                    </li>
                    <li><code>AssumeRoleWithWebIdentity</code> ‚Äì used by OIDC (EKS IRSA, GitHub Actions OIDC).</li>
                    <li><code>AssumeRoleWithSAML</code> ‚Äì used for enterprise SSO providers.</li>
                    <li><code>GetFederationToken</code> ‚Äì legacy federation helper.</li>
                </ul>
                <p><a href="https://docs.aws.amazon.com/STS/latest/APIReference/Welcome.html" rel="noopener"
                        target="_blank">STS API
                        reference ‚Üó</a></p>
            </div>
        </section>
        <section class="card" id="section-1-3">
            <div class="card-header">1.3 Lambda Execution Role (LER)</div>
            <div class="card-body">
                <p>
                    Every Lambda function references an execution role. When the function is invoked, the Lambda service
                    assumes that
                    role, and the runtime receives temporary credentials through environment variables or the AWS SDK
                    provider chain.
                </p>
                <p>Typical Lambda role permissions:</p>
                <ul>
                    <li>Baseline logging (<code>logs:CreateLogGroup</code>, <code>logs:CreateLogStream</code>,
                        <code>logs:PutLogEvents</code>).
                    </li>
                    <li>Application actions (S3 read/write, DynamoDB access, SNS publish, Secrets Manager usage).</li>
                </ul>
                <p>Example trust policy:</p>
                <pre><code class="language-json">{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Service": "lambda.amazonaws.com" },
      "Action": "sts:AssumeRole"
    }
  ]
}</code></pre>
                <p><a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-intro-execution-role.html"
                        rel="noopener" target="_blank">Lambda execution role docs ‚Üó</a></p>
            </div>
        </section>
        <section class="card" id="section-1-4">
            <div class="card-header">1.4 EC2 Instance Profiles</div>
            <div class="card-body">
                <p>
                    EC2 cannot attach a role directly, so AWS uses an <em>instance profile</em> containing exactly one
                    role. Applications
                    request credentials through the Instance Metadata Service v2 (IMDSv2): obtain a session token, then
                    retrieve access
                    key, secret key, session token, and expiration. SDKs refresh automatically before expiration.
                </p>
                <p>
                    IMDSv1 (the unauthenticated GET variant) is vulnerable to SSRF. Capital One‚Äôs breach leveraged
                    IMDSv1 to steal role
                    credentials. Always enforce IMDSv2.
                </p>
                <p><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html"
                        rel="noopener" target="_blank">EC2 role reference ‚Üó</a></p>
            </div>
        </section>
        <section class="card" id="section-1-5">
            <div class="card-header">1.5 Trust Policies: AWS‚Äôs Identity Firewall</div>
            <div class="card-body">
                <p>Trust policies define which principals can assume a role and under which conditions.</p>
                <ul>
                    <li><strong>Principal</strong> ‚Äì AWS service, account, role, or federated identity allowed to
                        assume.</li>
                    <li><strong>Action</strong> ‚Äì nearly always <code>sts:AssumeRole</code>.</li>
                    <li><strong>Condition</strong> ‚Äì contextual constraints such as <code>aws:SourceArn</code>,
                        <code>aws:SourceAccount</code>,
                        <code>sts:ExternalId</code>, or <code>aws:SourceIp</code>.
                    </li>
                </ul>
                <p>Example hardened trust policy:</p>
                <pre><code class="language-json">{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Service": "lambda.amazonaws.com" },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": { "aws:SourceAccount": "123456789012" },
        "ArnLike": { "aws:SourceArn": "arn:aws:lambda:us-east-1:123456789012:function:UserRegistration-*" }
      }
    }
  ]
}</code></pre>
            </div>
        </section>
        <section class="card" id="section-1-6">
            <div class="card-header">1.6 Knowledge Check</div>
            <div class="card-body">
                <div class="widget" id="quiz-aws-roles-foundations"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                            AppSecWidgets.Quiz.create("quiz-aws-roles-foundations", {
                                title: "üß† AWS Role Foundations Quiz",
                                intro: "Validate that you can explain STS-backed identities and why roles beat IAM users for workloads.",
                                mode: "step",
                                questions: [
                                    {
                                        text: "What is the primary benefit of using IAM roles for Lambda instead of embedding access keys?",
                                        options: [
                                            { value: "a", label: "Roles allow unlimited execution time", correct: false },
                                            { value: "b", label: "Roles rely on short-lived STS credentials that rotate automatically", correct: true },
                                            { value: "c", label: "Roles disable CloudWatch logging by default", correct: false },
                                            { value: "d", label: "Roles only work inside a single region", correct: false }
                                        ]
                                    },
                                    {
                                        text: "Which trust policy element restricts a role to specific Lambda functions?",
                                        options: [
                                            { value: "a", label: "aws:SourceArn", correct: true },
                                            { value: "b", label: "aws:RequestTag", correct: false },
                                            { value: "c", label: "iam:PassRole", correct: false },
                                            { value: "d", label: "s3:ExistingObjectTag", correct: false }
                                        ]
                                    },
                                    {
                                        text: "IMDSv2 is required because‚Ä¶",
                                        options: [
                                            { value: "a", label: "it speeds up EC2 boot times", correct: false },
                                            { value: "b", label: "it authenticates metadata requests using session tokens, blocking SSRF theft", correct: true },
                                            { value: "c", label: "it enables IPv6 only", correct: false },
                                            { value: "d", label: "it encrypts S3 traffic", correct: false }
                                        ]
                                    }
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-2">
            <div class="card-header">2. Intuitive Hook ‚Äì Temporary Badges in a Secure Facility</div>
            <div class="card-body">
                <p>
                    Imagine a government research lab. AWS services are workers who need temporary badges. IAM roles are
                    those badges,
                    trust policies are the guards verifying who can receive them, and permissions policies dictate which
                    labs each worker
                    can enter.
                </p>
            </div>
        </section>
        <section class="card" id="section-2-1">
            <div class="card-header">2.1 Badge Analogy</div>
            <div class="card-body">
                <ul>
                    <li><strong>IAM Role = Temporary badge</strong> ‚Äî includes doors it opens, floors allowed, and
                        expiration time.</li>
                    <li><strong>Trust Policy = Guard</strong> ‚Äî checks if the requester is the Lambda service from the
                        right account and invocation.</li>
                    <li><strong>Permissions Policy = Internal rulebook</strong> ‚Äî once inside, governs which S3 buckets,
                        DynamoDB tables, or IAM actions are allowed.</li>
                </ul>
                <p>If the guard is careless (e.g., <code>"Principal": "*"</code>):</p>
                <ul>
                    <li>Attackers or other AWS services can obtain badges not meant for them.</li>
                    <li>Cross-account impersonation becomes trivial.</li>
                    <li>Compromised workloads laterally move with powerful credentials.</li>
                </ul>
                <p>Thinking about roles as badges makes it easier to reason about:</p>
                <ul>
                    <li>Why each Lambda, EC2, or ECS workload needs its own role.</li>
                    <li>How STS credentials expire, mirroring badge revocation at shift end.</li>
                    <li>Why trust policies and <code>aws:SourceArn</code> conditions are the ‚Äúguards‚Äù preventing badge
                        fraud.</li>
                </ul>
            </div>
        </section>
        <section class="card" id="section-2-2">
            <div class="card-header">2.2 Knowledge Check</div>
            <div class="card-body">
                <div class="widget" id="quiz-aws-roles-hook"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                            AppSecWidgets.Quiz.create("quiz-aws-roles-hook", {
                                title: "üé´ Badge Analogy Quiz",
                                questions: [
                                    {
                                        text: "Within the badge analogy, what does the trust policy represent?",
                                        options: [
                                            { value: "a", label: "The building‚Äôs cafeteria menu", correct: false },
                                            { value: "b", label: "The security guard validating identities before issuing badges", correct: true },
                                            { value: "c", label: "The HR system tracking PTO", correct: false },
                                            { value: "d", label: "The elevators used by visitors", correct: false }
                                        ]
                                    },
                                    {
                                        text: "What happens if the badge (role) lists \"Action: *\"?",
                                        options: [
                                            { value: "a", label: "Only one lab can be entered", correct: false },
                                            { value: "b", label: "Badge holders gain near-admin power inside AWS", correct: true },
                                            { value: "c", label: "Badges never expire", correct: false },
                                            { value: "d", label: "The guard automatically revokes the badge", correct: false }
                                        ]
                                    }
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-3">
            <div class="card-header">3. Mental Model ‚Äî Why ‚Üí How ‚Üí What-If</div>
            <div class="card-body">
                <p>
                    A strong AWS identity mental model layers business drivers (why roles exist), platform mechanics
                    (how trust is
                    granted and enforced), and failure scenarios (what happens when configurations drift). This overview
                    aligns all three
                    before you drill into the subsections.
                </p>
            </div>
        </section>
        <section class="card" id="section-3-1">
            <div class="card-header">3.1 WHY Roles Matter</div>
            <div class="card-body">
                <ol>
                    <li>
                        <strong>Eliminate long-lived credentials.</strong>
                        Access keys leak through repos, screenshots, logs, CI artifacts, and rarely expire. Roles issue
                        STS credentials
                        that die on schedule, so attackers can‚Äôt persist.
                    </li>
                    <li>
                        <strong>Enforce isolation across services.</strong>
                        Each workload (Lambda, EC2, ECS, Glue, Step Functions) receives a bespoke role. Compromising
                        ingestion Lambda no
                        longer grants permission to modify DynamoDB or Secrets Manager used by unrelated services.
                    </li>
                    <li>
                        <strong>Support cross-account security patterns.</strong>
                        Multi-account setups (dev ‚Üí staging ‚Üí prod, centralized security tooling, vendor integrations)
                        are safe because
                        trust policies explicitly list which account or service may assume the role.
                    </li>
                </ol>
                <p><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html" rel="noopener"
                        target="_blank">AWS IAM
                        best practices ‚Üó</a></p>
            </div>
        </section>
        <section class="card" id="section-3-2">
            <div class="card-header">3.2 HOW AWS Roles Work Internally</div>
            <div class="card-body">
                <h4>A. Service ‚Üí Control Plane ‚Üí STS ‚Üí Credentials</h4>
                <ol>
                    <li>Workload (Lambda invocation, EC2 boot, ECS task) triggers the AWS control plane.</li>
                    <li>The control plane evaluates the role‚Äôs <strong>trust policy</strong>.</li>
                    <li>If allowed, AWS STS issues short-lived credentials for that role.</li>
                    <li>Credentials are delivered through environment variables (Lambda), IMDSv2 (EC2), ECS task
                        metadata, or EKS IRSA web identity tokens.</li>
                    <li>The AWS SDK in the workload signs requests using those credentials.</li>
                </ol>
                <h4>B. Permissions Evaluated on Every Request</h4>
                <ol>
                    <li>Temporary credentials reference the role‚Äôs permissions policy.</li>
                    <li>Service-linked permissions and resource policies (S3 buckets, KMS keys) further scope access.
                    </li>
                    <li>Permission boundaries or Service Control Policies (SCPs) may deny actions even if the role
                        allows them.</li>
                    <li>The request is allowed only if <em>every</em> relevant policy permits it.</li>
                </ol>
                <p><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_evaluation-logic.html"
                        rel="noopener" target="_blank">IAM evaluation logic ‚Üó</a></p>
            </div>
        </section>
        <section class="card" id="section-3-3">
            <div class="card-header">3.3 WHAT-IF Scenarios</div>
            <div class="card-body">
                <div class="callout callout-warning">
                    <strong>Misconfigured trust or permissions translate directly into compromised identities.</strong>
                    Keep these scenarios in your review checklist.
                </div>
                <ul>
                    <li>
                        <strong>Trust policy is too broad.</strong>
                        <pre><code class="language-json">"Principal": "*"</code></pre>
                        Any AWS principal can assume the role, enabling trivial cross-account takeovers.
                    </li>
                    <li>
                        <strong>Lambda role has <code>Action: "*"</code>.</strong>
                        A simple RCE in Lambda becomes full-account compromise (create IAM users, delete logs,
                        exfiltrate data).
                    </li>
                    <li>
                        <strong>EC2 uses IMDSv1.</strong>
                        SSRF attackers can query metadata without a session token and steal credentials. This is the
                        Capital One breach pattern. <a
                            href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html"
                            rel="noopener" target="_blank">IMDSv2 hardening guide ‚Üó</a>
                    </li>
                    <li>
                        <strong>Cross-account role lacks <code>sts:ExternalId</code>.</strong>
                        Malicious accounts impersonate trusted vendors (confused deputy attack).
                    </li>
                </ul>
            </div>
        </section>
        <section class="card" id="section-3-4">
            <div class="card-header">3.4 Knowledge Check</div>
            <div class="card-body">
                <div class="widget" id="quiz-aws-roles-mental"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                            AppSecWidgets.Quiz.create("quiz-aws-roles-mental", {
                                title: "üß≠ Mental Model Quiz",
                                questions: [
                                    {
                                        text: "Which step happens first when Lambda invokes an AWS API?",
                                        options: [
                                            { value: "a", label: "Lambda runtime generates its own credentials", correct: false },
                                            { value: "b", label: "AWS control plane checks the role's trust policy and calls STS", correct: true },
                                            { value: "c", label: "GuardDuty reviews the request", correct: false },
                                            { value: "d", label: "KMS decrypts a data key", correct: false }
                                        ]
                                    },
                                    {
                                        text: "Why does a broad trust policy immediately raise a critical finding?",
                                        options: [
                                            { value: "a", label: "Because it reduces function concurrency", correct: false },
                                            { value: "b", label: "Because any AWS principal can assume the role and pivot", correct: true },
                                            { value: "c", label: "Because STS stops issuing credentials", correct: false },
                                            { value: "d", label: "Because IMDSv2 disables the role", correct: false }
                                        ]
                                    }
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-4">
            <div class="card-header">4. Deep Explanation (Step-by-Step)</div>
            <div class="card-body">
                <p>
                    This section dissects the full lifecycle of Lambda execution roles, EC2 instance profiles, and trust
                    policy design so
                    you can review them line by line.
                </p>
            </div>
        </section>
        <section class="card" id="section-4-1">
            <div class="card-header">4.1 Lambda Execution Role Lifecycle</div>
            <div class="card-body">
                <ol>
                    <li><strong>Invocation.</strong> API Gateway, EventBridge, S3 events, or direct invoke triggers
                        Lambda.</li>
                    <li><strong>Control plane validation.</strong> AWS validates configuration and references the
                        execution role.</li>
                    <li><strong>STS assumption.</strong> Lambda service assumes the role and receives credentials.</li>
                    <li><strong>Credential injection.</strong> Temporary credentials appear in environment variables and
                        AWS SDK providers.</li>
                    <li><strong>Execution.</strong> Lambda code calls AWS APIs using these permissions.</li>
                    <li><strong>Expiration.</strong> Credentials expire; fresh invocations receive new ones.</li>
                </ol>
                <div class="callout callout-info">
                    A Lambda with command injection gives attackers the same abilities as the execution role. Review its
                    policies as if they were standing IAM users.
                </div>
            </div>
        </section>
        <section class="card" id="section-4-2">
            <div class="card-header">4.2 EC2 Instance Profile Lifecycle</div>
            <div class="card-body">
                <ol>
                    <li>EC2 boots with an instance profile binding to a single IAM role.</li>
                    <li>Workload sends <code>PUT</code> request to IMDSv2 to obtain a session token.</li>
                    <li>Workload fetches credentials using that token:
                        <pre><code>GET http://169.254.169.254/latest/meta-data/iam/security-credentials/&lt;RoleName&gt;
X-aws-ec2-metadata-token: &lt;token&gt;</code></pre>
                    </li>
                    <li>IMDSv2 returns temporary access key, secret, session token, and expiration.</li>
                    <li>SDK refreshes automatically; developers don‚Äôt handle keys directly.</li>
                </ol>
                <table>
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>IMDSv1</th>
                            <th>IMDSv2</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Requires session token</td>
                            <td>No</td>
                            <td>Yes</td>
                        </tr>
                        <tr>
                            <td>SSRF protection</td>
                            <td>Weak</td>
                            <td>Strong</td>
                        </tr>
                        <tr>
                            <td>Enforced hop count</td>
                            <td>No</td>
                            <td>Yes</td>
                        </tr>
                        <tr>
                            <td>Capital One exploit viable?</td>
                            <td>Yes</td>
                            <td>No</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        <section class="card" id="section-4-3">
            <div class="card-header">4.3 Trust Policy Construction</div>
            <div class="card-body">
                <p>A trust policy states ‚ÄúThis role can be assumed by this principal, using this mechanism, under these
                    conditions.‚Äù</p>
                <ul>
                    <li><strong>Principal</strong> ‚Äì service principal, AWS account, IAM user/role, or federated IdP.
                    </li>
                    <li><strong>Action</strong> ‚Äì typically <code>sts:AssumeRole</code>.</li>
                    <li><strong>Conditions</strong> ‚Äì <code>aws:SourceArn</code>, <code>aws:SourceAccount</code>,
                        <code>sts:ExternalId</code>, <code>sts:RoleSessionName</code> for fine-grained constraints.
                    </li>
                </ul>
                <p>Secure example for Lambda:</p>
                <pre><code class="language-json">{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Service": "lambda.amazonaws.com" },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": { "aws:SourceAccount": "123456789012" },
        "ArnLike": { "aws:SourceArn": "arn:aws:lambda:us-east-1:123456789012:function:PaymentsProcessor" }
      }
    }
  ]
}</code></pre>
            </div>
        </section>
        <section class="card" id="section-4-4">
            <div class="card-header">4.4 Bad vs Good Trust Policies</div>
            <div class="card-body">
                <div class="widget" id="configdiff-aws-trust"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.ConfigDiff) {
                            AppSecWidgets.ConfigDiff.create(
                                "configdiff-aws-trust",
                                "üîí Trust Policy Hardening",
                                `"Principal": "*"`,
                                `{
  "Principal": { "Service": "lambda.amazonaws.com" },
  "Action": "sts:AssumeRole",
  "Condition": {
    "StringEquals": { "aws:SourceAccount": "123456789012" },
    "ArnLike": { "aws:SourceArn": "arn:aws:lambda:*:123456789012:function:Order*" }
  }
}`
                            );
                        }
                    });
                </script>
                <p>The insecure versions remove authentication altogether; the secure policy binds both the service
                    principal and the exact Lambda ARNs allowed to assume it.</p>
            </div>
        </section>
        <section class="card" id="section-4-5">
            <div class="card-header">4.5 Confused Deputy Protection with <code>sts:ExternalId</code></div>
            <div class="card-body">
                <p>
                    When delegating to third-party vendors, always require a unique ExternalId so malicious AWS accounts
                    cannot impersonate them. Vendors include this value when assuming your role, and IAM validates it
                    before issuing credentials.
                </p>
                <p><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user_externalid.html"
                        rel="noopener" target="_blank">AWS ExternalId guidance ‚Üó</a></p>
            </div>
        </section>
        <section class="card" id="section-4-6">
            <div class="card-header">4.6 Knowledge Check</div>
            <div class="card-body">
                <div class="widget" id="quiz-aws-roles-deep"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                            AppSecWidgets.Quiz.create("quiz-aws-roles-deep", {
                                title: "üî¨ Deep Dive Quiz",
                                questions: [
                                    {
                                        text: "What is the final gating factor before Lambda code uses AWS APIs?",
                                        options: [
                                            { value: "a", label: "CloudWatch alarm approval", correct: false },
                                            { value: "b", label: "STS credentials injected into the runtime", correct: true },
                                            { value: "c", label: "Manual IAM user login", correct: false },
                                            { value: "d", label: "GuardDuty suppression list update", correct: false }
                                        ]
                                    },
                                    {
                                        text: "Which condition blocks confused deputy attacks for third-party roles?",
                                        options: [
                                            { value: "a", label: "aws:MultiFactorAuthPresent", correct: false },
                                            { value: "b", label: "sts:ExternalId", correct: true },
                                            { value: "c", label: "ec2:InstanceType", correct: false },
                                            { value: "d", label: "s3:ExistingObjectTag", correct: false }
                                        ]
                                    }
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-5">
            <div class="card-header">5. Real-World Context &amp; Interactions</div>
            <div class="card-body">
                <p>
                    Consider a multi-account SaaS pipeline that ingests data via Lambda, processes it on EC2, and
                    centralizes logging in
                    a security account. Every hop depends on well-scoped service roles. The subsections break down the
                    architecture,
                    trust boundaries, flows, and validation tools.
                </p>
            </div>
        </section>
        <section class="card" id="section-5-1">
            <div class="card-header">5.1 Scenario: Event-Driven Data Processing Pipeline</div>
            <div class="card-body">
                <p>Accounts and responsibilities:</p>
                <ul>
                    <li><strong>Account A (Edge)</strong> ‚Äì API Gateway and ingestion Lambdas.</li>
                    <li><strong>Account B (Core)</strong> ‚Äì EC2 processing fleet reacting to S3 events.</li>
                    <li><strong>Account C (Security)</strong> ‚Äì Central logging, SIEM, IAM Access Analyzer.</li>
                </ul>
                <pre>
[API Gateway]
      |
      v
[Ingestion Lambda] --(stores files)--&gt; [S3 Bucket]
      |
      v
[SNS Topic] ------------------------------+
                                          |
                                          v
                               [EC2 Processing Cluster]
                                          |
                                          +--&gt; [DynamoDB]
                                          |
                                          +--&gt; [Central Logging / SIEM]
        </pre>
                <table>
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Role</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Lambda Ingestor</td>
                            <td>LambdaExecutionRole</td>
                            <td>Write logs, put S3 objects, publish SNS messages</td>
                        </tr>
                        <tr>
                            <td>EC2 Processor</td>
                            <td>EC2InstanceRole</td>
                            <td>Read S3, write DynamoDB, fetch one secret</td>
                        </tr>
                        <tr>
                            <td>Security Services</td>
                            <td>SecurityRole</td>
                            <td>Ingest logs, run Access Analyzer, operate GuardDuty</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        <section class="card" id="section-5-2">
            <div class="card-header">5.2 Identity and Trust Boundaries</div>
            <div class="card-body">
                <ul>
                    <li><strong>Lambda:</strong> trust policy principal <code>lambda.amazonaws.com</code>, permissions
                        limited to specific S3 bucket and SNS topics.</li>
                    <li><strong>EC2:</strong> trust policy principal <code>ec2.amazonaws.com</code>, permissions for
                        bucket reads, DynamoDB writes, and <em>one</em> secret.</li>
                    <li><strong>S3 bucket policy:</strong>
                        <pre><code class="language-json">{
  "Effect": "Allow",
  "Principal": {"AWS": "arn:aws:iam::B:role/EC2ProcessorRole"},
  "Action": "s3:GetObject",
  "Resource": "arn:aws:s3:::inbound-data/*"
}</code></pre>
                    </li>
                </ul>
            </div>
        </section>
        <section class="card" id="section-5-3">
            <div class="card-header">5.3 Interaction Diagram</div>
            <div class="card-body">
                <pre>
[Lambda] --AssumeRole--&gt; [STS] --TempCreds--&gt; [Lambda Runtime]
    |                                      |
    +------&gt; S3:PutObject ------------------+

[EC2 Node] --IMDSv2--&gt; [Role Creds] --&gt; [SDK Calls]
    |                                 |
    +--&gt; S3:GetObject ----------------+
    +--&gt; DynamoDB:PutItem ------------+
        </pre>
            </div>
        </section>
        <section class="card" id="section-5-4">
            <div class="card-header">5.4 Flow Visualizer</div>
            <div class="card-body">
                <div class="widget" id="flow-aws-service-roles"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.FlowVisualizer) {
                            AppSecWidgets.FlowVisualizer.create("flow-aws-service-roles", {
                                title: "üîÑ Identity Flow Across Accounts",
                                steps: [
                                    { title: "Lambda Triggered", description: "API Gateway event triggers ingestion Lambda in Account A." },
                                    { title: "STS Assumption", description: "Lambda service assumes LambdaExecutionRole via STS." },
                                    { title: "S3 Fan-out", description: "Lambda writes to S3 and publishes SNS notifications scoped by its policy." },
                                    { title: "EC2 Credential Retrieval", description: "EC2 instances obtain IMDSv2 tokens and role creds in Account B." },
                                    { title: "Processing & Logging", description: "EC2 writes to DynamoDB and forwards logs to the security account." }
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-5-5">
            <div class="card-header">5.5 Widget-Ready Data</div>
            <div class="card-body">
                <p>Use ConfigDiff to highlight unscoped vs scoped policies, CodeReviewChecker for JSON analysis, and
                    APITester to simulate least privilege requirements when building custom labs.</p>
            </div>
        </section>
        <section class="card" id="section-5-6">
            <div class="card-header">5.6 Knowledge Check</div>
            <div class="card-body">
                <div class="widget" id="quiz-aws-roles-context"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                            AppSecWidgets.Quiz.create("quiz-aws-roles-context", {
                                title: "üèóÔ∏è Architecture Quiz",
                                questions: [
                                    {
                                        text: "Why does the EC2 role limit Secrets Manager access to one secret?",
                                        options: [
                                            { value: "a", label: "To stay under IAM quota limits", correct: false },
                                            { value: "b", label: "To enforce least privilege if EC2 is compromised", correct: true },
                                            { value: "c", label: "Because EC2 cannot read Secrets Manager", correct: false },
                                            { value: "d", label: "Because Lambda already reads secrets", correct: false }
                                        ]
                                    },
                                    {
                                        text: "What ensures Account C can read logs across accounts?",
                                        options: [
                                            { value: "a", label: "A bucket policy that lists the SecurityRole ARN", correct: true },
                                            { value: "b", label: "Disabling GuardDuty", correct: false },
                                            { value: "c", label: "Creating IAM users with static keys", correct: false },
                                            { value: "d", label: "Allowing Principal '*''", correct: false }
                                        ]
                                    }
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-6">
            <div class="card-header">6. Common Weaknesses, Pitfalls &amp; Attack Paths</div>
            <div class="card-body">
                <p>Focus on the weaknesses AppSec teams repeatedly uncover in AWS role reviews.</p>
            </div>
        </section>
        <section class="card" id="section-6-1">
            <div class="card-header">6.1 Weakness ‚Äî Over-Privileged Permissions</div>
            <div class="card-body">
                <p>Policies with <code>Action": "*"</code> or <code>Resource": "*"</code> grant attackers broad power
                    once code execution occurs. Mitigation: enforce least privilege and scope ARNs.</p>
            </div>
        </section>
        <section class="card" id="section-6-2">
            <div class="card-header">6.2 Weakness ‚Äî Broad Trust Policies</div>
            <div class="card-body">
                <p>Trust policies such as <code>"Principal": "*"</code> allow any AWS principal to assume the role.
                    Detect via CloudTrail <code>AssumeRole</code> from unknown accounts and GuardDuty findings like
                    <code>UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration</code>. Require
                    <code>aws:SourceAccount</code> and <code>aws:SourceArn</code>.
                </p>
            </div>
        </section>
        <section class="card" id="section-6-3">
            <div class="card-header">6.3 Weakness ‚Äî IMDSv1 Exposure (Capital One Pattern)</div>
            <div class="card-body">
                <pre>
Attacker ‚Üí SSRF ‚Üí http://169.254.169.254/latest/meta-data/iam/
                           |
                           +--&gt; Temporary STS credentials
        </pre>
                <p>Enforce IMDSv2 with:</p>
                <pre><code class="language-bash">aws ec2 modify-instance-metadata-options \
  --instance-id i-123456 \
  --http-endpoint enabled \
  --http-tokens required</code></pre>
                <div class="widget" id="configdiff-imds"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.ConfigDiff) {
                            AppSecWidgets.ConfigDiff.create(
                                "configdiff-imds",
                                "üÜö IMDSv1 vs IMDSv2",
                                `aws ec2 modify-instance-metadata-options \
  --instance-id i-123456 \
  --http-endpoint enabled \
  --http-tokens optional`,
                                `aws ec2 modify-instance-metadata-options \
  --instance-id i-123456 \
  --http-endpoint enabled \
  --http-tokens required`
                            );
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-6-4">
            <div class="card-header">6.4 Weakness ‚Äî Missing ExternalId</div>
            <div class="card-body">
                <p>Third-party roles without <code>sts:ExternalId</code> let any AWS account impersonate the vendor.
                    Always require a unique identifier per customer.</p>
            </div>
        </section>
        <section class="card" id="section-6-5">
            <div class="card-header">6.5 Weakness ‚Äî Excessive KMS Privileges</div>
            <div class="card-body">
                <p>Granting <code>"kms:*"</code> allows key deletion, tampering, and decryption of sensitive data. Scope
                    KMS actions to explicit keys and operations.</p>
            </div>
        </section>
        <section class="card" id="section-6-6">
            <div class="card-header">6.6 Attack Sandbox</div>
            <div class="card-body">
                <div class="widget" id="sandbox-aws-metadata"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.AttackSandbox) {
                            AppSecWidgets.AttackSandbox.create("sandbox-aws-metadata", {
                                title: "üéØ SSRF to Metadata Attack",
                                scenarios: [
                                    {
                                        name: "SSRF Metadata Theft",
                                        description: "Simulate an attacker abusing SSRF to query IMDSv1 and steal credentials.",
                                        payload: "GET /latest/meta-data/iam/security-credentials/",
                                        response: "HTTP/200 Temporary STS credentials leaked",
                                        notifyType: "danger",
                                        notifyMessage: "Metadata credentials exposed!",
                                    }
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-6-7">
            <div class="card-header">6.7 Log Analyzer</div>
            <div class="card-body">
                <div class="widget" id="logs-aws-roles"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.LogAnalyzer) {
                            AppSecWidgets.AdvancedLogAnalyzer.create("logs-aws-roles", {
                                title: "üîç AWS Service Role Abuse ‚Äì Detection Signals",
                                columns: ["Time", "IP", "Event", "Principal"],
                                logs: [
                                    {
                                        time: "2024-05-01T12:03Z",
                                        event: "Access Analyzer: Role trust policy allows sts:AssumeRole from unknown external account 998877665544",
                                        principal: "arn:aws:iam::111111111111:role/EC2Processor",
                                        ip: "-",
                                        severity: "warning",
                                        mitre: "TA0001 Initial Access",
                                        tags: ["IAM", "Trust Policy", "Misconfiguration"]
                                    },
                                    {
                                        time: "2024-05-01T12:08Z",
                                        event: "Cross-account AssumeRole successful from suspicious AWS account 998877665544",
                                        principal: "arn:aws:iam::111111111111:role/AppLambda",
                                        ip: "203.0.113.8",
                                        severity: "danger",
                                        mitre: "TA0003 Persistence",
                                        tags: ["sts:AssumeRole", "Cross-Account", "Privilege Misuse"]
                                    },
                                    {
                                        time: "2024-05-01T12:10Z",
                                        event: "GuardDuty: UnauthorizedAccess ‚Äì EC2/MetadataCredentials exfiltration attempt",
                                        principal: "i-0abc1234def567890",
                                        ip: "198.51.100.45",
                                        severity: "danger",
                                        mitre: "TA0006 Credential Access",
                                        tags: ["EC2", "IMDSv2 Missing", "Metadata", "STS"]
                                    },
                                    {
                                        time: "2024-05-01T12:12Z",
                                        event: "STS:AssumeRole ‚Üí Privilege Escalation path detected (role-chaining across 3 roles)",
                                        principal: "arn:aws:iam::111111111111:role/AppLambda",
                                        ip: "203.0.113.8",
                                        severity: "warning",
                                        mitre: "TA0004 Privilege Escalation",
                                        tags: ["Role Chaining", "STS", "Escalation"]
                                    },
                                    {
                                        time: "2024-05-01T12:15Z",
                                        event: "Access Analyzer: Public role trust ‚Äì service role assumable by ANY AWS account",
                                        principal: "arn:aws:iam::111111111111:role/EC2Processor",
                                        ip: "-",
                                        severity: "warning",
                                        mitre: "TA0001 Initial Access",
                                        tags: ["Public Trust", "IAM", "Misconfiguration"]
                                    },
                                    {
                                        time: "2024-05-01T12:17Z",
                                        event: "CloudTrail: Lambda execution role used to list S3 buckets outside intended scope",
                                        principal: "arn:aws:sts::111111111111:assumed-role/AppLambda/session-xyz",
                                        ip: "54.240.197.4",
                                        severity: "info",
                                        mitre: "TA0007 Discovery",
                                        tags: ["Lambda", "Least Privilege Violation"]
                                    },
                                    {
                                        time: "2024-05-01T12:21Z",
                                        event: "GuardDuty: PrivilegeEscalation ‚Äì IAMUser/InvokeAdminRole via misconfigured trust",
                                        principal: "arn:aws:iam::111111111111:user/ci-build-user",
                                        ip: "203.0.113.110",
                                        severity: "danger",
                                        mitre: "TA0004 Privilege Escalation",
                                        tags: ["IAM", "Privilege Escalation", "Trust Policy"]
                                    }
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-6-8">
            <div class="card-header">6.8 Knowledge Check</div>
            <div class="card-body">
                <div class="widget" id="quiz-aws-roles-weaknesses"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                            AppSecWidgets.Quiz.create("quiz-aws-roles-weaknesses", {
                                title: "üö® Weakness Quiz",
                                questions: [
                                    {
                                        text: "Which GuardDuty finding indicates metadata credential theft?",
                                        options: [
                                            { value: "a", label: "PenTest:IAMUser/Kali", correct: false },
                                            { value: "b", label: "UnauthorizedAccess:EC2/MetadataCredentials", correct: true },
                                            { value: "c", label: "Stealth:IAMUser/CloudTrailDisabled", correct: false },
                                            { value: "d", label: "CryptoCurrency:EC2/BitcoinTool", correct: false }
                                        ]
                                    },
                                    {
                                        text: "How do you prevent a confused deputy attack for vendor roles?",
                                        options: [
                                            { value: "a", label: "Enable IMDSv2", correct: false },
                                            { value: "b", label: "Require sts:ExternalId in the trust policy", correct: true },
                                            { value: "c", label: "Attach AdministratorAccess", correct: false },
                                            { value: "d", label: "Use IAM users with MFA", correct: false }
                                        ]
                                    }
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-7">
            <div class="card-header">7. Practical Implementation &amp; Review (Hands-On)</div>
            <div class="card-body">
                <p>This section mirrors the commands, JSON, and detection artefacts AppSec engineers review in real AWS
                    environments.</p>
            </div>
        </section>
        <section class="card" id="section-7-1">
            <div class="card-header">7.1 Create a Secure Lambda Execution Role</div>
            <div class="card-body">
                <ol>
                    <li>Create the trust policy:
                        <pre><code class="language-json">{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": { "Service": "lambda.amazonaws.com" },
    "Action": "sts:AssumeRole",
    "Condition": {
      "StringEquals": { "aws:SourceAccount": "123456789012" },
      "ArnLike": { "aws:SourceArn": "arn:aws:lambda:us-east-1:123456789012:function:DataIngest*" }
    }
  }]
}</code></pre>
                    </li>
                    <li>Create the role via CLI:
                        <pre><code class="language-bash">aws iam create-role \
  --role-name LambdaDataIngestRole \
  --assume-role-policy-document file://trust.json</code></pre>
                    </li>
                    <li>Attach baseline permissions:
                        <pre><code class="language-bash">aws iam attach-role-policy \
  --role-name LambdaDataIngestRole \
  --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole</code></pre>
                    </li>
                    <li>Add application-specific permissions:
                        <pre><code class="language-json">{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Action": "s3:PutObject",
    "Resource": "arn:aws:s3:::incoming-data/*"
  }]
}</code></pre>
                    </li>
                </ol>
            </div>
        </section>
        <section class="card" id="section-7-2">
            <div class="card-header">7.2 Create EC2 Instance Profiles Correctly</div>
            <div class="card-body">
                <ol>
                    <li>Create role:
                        <pre><code class="language-bash">aws iam create-role --role-name EC2ProcessorRole --assume-role-policy-document file://ec2-trust.json</code></pre>
                    </li>
                    <li>Create instance profile:
                        <pre><code class="language-bash">aws iam create-instance-profile --instance-profile-name ProcessorInstanceProfile</code></pre>
                    </li>
                    <li>Attach role to profile:
                        <pre><code class="language-bash">aws iam add-role-to-instance-profile \
  --instance-profile-name ProcessorInstanceProfile \
  --role-name EC2ProcessorRole</code></pre>
                    </li>
                    <li>Enforce IMDSv2:
                        <pre><code class="language-bash">aws ec2 modify-instance-metadata-options \
  --instance-id i-12345abcdef \
  --http-tokens required \
  --http-endpoint enabled</code></pre>
                    </li>
                </ol>
            </div>
        </section>
        <section class="card" id="section-7-3">
            <div class="card-header">7.3 Secure vs Insecure Trust Policies</div>
            <div class="card-body">
                <div class="widget" id="configdiff-aws-secure-trust"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.ConfigDiff) {
                            AppSecWidgets.ConfigDiff.create(
                                "configdiff-aws-secure-trust",
                                "‚öñÔ∏è Trust Policy Review",
                                `{
                                    "Principal": "*",
                                    "Action": "sts:AssumeRole"
                                }`,
                                `{
                                    "Principal": { "Service": "ec2.amazonaws.com" },
                                    "Action": "sts:AssumeRole",
                                    "Condition": {
                                        "StringEquals": { "aws:SourceAccount": "123456789012" }
                                    }
                                }`
                            );
                        }
                    });
                </script>
                <p>The insecure variant grants universal assumption. The secure version restricts to EC2 in one account.
                </p>
            </div>
        </section>
        <section class="card" id="section-7-4">
            <div class="card-header">7.4 Logs &amp; Detection</div>
            <div class="card-body">
                <p>Example GuardDuty finding:</p>
                <pre>
Type: UnauthorizedAccess:EC2/MetadataCredentials
Severity: High
Description: Suspicious retrieval of role credentials from EC2 metadata.
        </pre>
                <p>CloudTrail investigations should look for <code>AssumeRole</code> calls from unusual account IDs or
                    regions.</p>
            </div>
        </section>
        <section class="card" id="section-7-5">
            <div class="card-header">7.5 Knowledge Check</div>
            <div class="card-body">
                <div class="widget" id="quiz-aws-roles-hands-on"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                            AppSecWidgets.Quiz.create("quiz-aws-roles-hands-on", {
                                title: "üõ†Ô∏è Implementation Quiz",
                                questions: [
                                    {
                                        text: "Why do we enforce IMDSv2 with --http-tokens required?",
                                        options: [
                                            { value: "a", label: "To let unauthenticated SSRF calls read metadata", correct: false },
                                            { value: "b", label: "To require session tokens before metadata is returned", correct: true },
                                            { value: "c", label: "To disable metadata entirely", correct: false },
                                            { value: "d", label: "To improve billing metrics", correct: false }
                                        ]
                                    },
                                    {
                                        text: "Which CLI command attaches a role to an instance profile?",
                                        options: [
                                            { value: "a", label: "aws iam attach-role-policy", correct: false },
                                            { value: "b", label: "aws iam add-role-to-instance-profile", correct: true },
                                            { value: "c", label: "aws iam pass-role", correct: false },
                                            { value: "d", label: "aws sts assume-role", correct: false }
                                        ]
                                    }
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-8">
            <div class="card-header">8. Good Design Principles, Defense &amp; Mitigation</div>
            <div class="card-body">
                <p>Translate best practices into concrete design rules, monitoring controls, and reviewer checklists.
                </p>
            </div>
        </section>
        <section class="card" id="section-8-1">
            <div class="card-header">8.1 Design Principles for AWS Roles</div>
            <div class="card-body">
                <ul>
                    <li><strong>Principle of least privilege.</strong> Use specific ARNs, limit DynamoDB actions, avoid
                        <code>*</code> resources.
                    </li>
                    <li><strong>Defense in depth.</strong> Combine IAM policies, permission boundaries, SCPs, resource
                        policies, KMS key policies, and continuous logging (CloudTrail, GuardDuty).</li>
                    <li><strong>Strong trust boundaries.</strong> Bind SourceArn and SourceAccount, restrict principals
                        to services, require ExternalId for vendor/OIDC roles.</li>
                    <li><strong>Mandate IMDSv2.</strong> Treat metadata service hardening as table stakes.</li>
                    <li><strong>Avoid role reuse.</strong> Every workload (Lambda, EC2, ECS) gets its own role.</li>
                </ul>
            </div>
        </section>
        <section class="card" id="section-8-2">
            <div class="card-header">8.2 AWS-Specific Controls</div>
            <div class="card-body">
                <ul>
                    <li><strong>IAM Access Analyzer</strong> ‚Äì finds unused or public permissions.</li>
                    <li><strong>AWS Organizations + SCPs</strong> ‚Äì block risky actions like disabling CloudTrail or
                        creating wildcard roles.</li>
                    <li><strong>GuardDuty</strong> ‚Äì detects STS theft, metadata abuse, and privilege escalations.</li>
                    <li><strong>CloudWatch alarms</strong> ‚Äì alert on S3 spikes, unusual DynamoDB operations, or
                        AssumeRole surges.</li>
                </ul>
            </div>
        </section>
        <section class="card" id="section-8-3">
            <div class="card-header">8.3 Reviewer Checklist</div>
            <div class="card-body">
                <div class="widget" id="checklist-aws-roles"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.Checklist) {
                            AppSecWidgets.Checklist.create("checklist-aws-roles", {
                                title: "üßæ AWS Role Security Checklist",
                                items: [
                                    "Trust policy uses explicit principals",
                                    "aws:SourceArn enforced where possible",
                                    "Permissions scoped to specific resources",
                                    "IMDSv2 required on all EC2 instances",
                                    "CloudTrail and GuardDuty enabled across accounts"
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-8-4">
            <div class="card-header">8.4 Pattern Library</div>
            <div class="card-body">
                <div class="widget" id="patterns-aws-roles"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.PatternLibrary) {
                            AppSecWidgets.PatternLibrary.create("patterns-aws-roles", {
                                title: "üìö Secure Role Patterns",
                                patterns: [
                                    {
                                        id: "lambda-role",
                                        title: "Scoped Lambda Execution Role",
                                        context: "Event-driven ingestion Lambda writing to a single S3 bucket.",
                                        rules: [
                                            "Principal lambda.amazonaws.com",
                                            "aws:SourceArn binds to the function ARN",
                                            "Permissions limited to CloudWatch Logs + one S3 prefix"
                                        ]
                                    },
                                    {
                                        id: "ec2-role",
                                        title: "EC2 Instance Profile with IMDSv2",
                                        context: "Processing fleet needs S3 read, DynamoDB write, single secret read.",
                                        rules: [
                                            "IMDSv2 required with hop limit",
                                            "KMS & Secrets Manager scoped to exact ARN",
                                            "DynamoDB actions limited to PutItem"
                                        ]
                                    },
                                    {
                                        id: "external-vendor",
                                        title: "ExternalId Vendor Role",
                                        context: "Third-party monitoring service pulls logs via cross-account role.",
                                        rules: [
                                            "Principal lists vendor AWS account",
                                            "Require unique sts:ExternalId per tenant",
                                            "Read-only permissions to logging buckets"
                                        ]
                                    }
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-8-5">
            <div class="card-header">8.5 Knowledge Check</div>
            <div class="card-body">
                <div class="widget" id="quiz-aws-roles-defense"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                            AppSecWidgets.Quiz.create("quiz-aws-roles-defense", {
                                title: "üõ°Ô∏è Defense Quiz",
                                questions: [
                                    {
                                        text: "Which control surfaces unused or public permissions automatically?",
                                        options: [
                                            { value: "a", label: "IAM Access Analyzer", correct: true },
                                            { value: "b", label: "AWS Shield", correct: false },
                                            { value: "c", label: "Amazon Macie", correct: false },
                                            { value: "d", label: "Trusted Advisor", correct: false }
                                        ]
                                    },
                                    {
                                        text: "What is the recommended response when reviewers find role reuse across services?",
                                        options: [
                                            { value: "a", label: "Allow reuse to reduce IAM objects", correct: false },
                                            { value: "b", label: "Break out dedicated roles per workload", correct: true },
                                            { value: "c", label: "Switch to IAM users", correct: false },
                                            { value: "d", label: "Disable CloudTrail", correct: false }
                                        ]
                                    }
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-9">
            <div class="card-header">9. Incident Case Study ‚Äì Capital One-Style Metadata Theft</div>
            <div class="card-body">
                <p>
                    The 2019 Capital One breach illustrates how <strong>one misconfigured IAM role</strong> plus legacy
                    IMDSv1 exposed
                    millions of records. A WAF with an SSRF bug could query <code>169.254.169.254</code>, steal the EC2
                    instance profile
                    credentials, and replay them across AWS services because the trust policy allowed broad assumption
                    and the role held
                    administrative permissions. The subsections break down the environment, timeline, attack chain, and
                    remediation
                    artifacts AppSec reviewers should internalize.
                </p>
                <p><a href="https://www.dhs.gov/sites/default/files/publications/19_1220_cisa_capital-one-cloud-breach-analysis.pdf"
                        rel="noopener" target="_blank">CISA analysis ‚Üó</a>
                    ¬∑ <a href="https://www.senate.gov/imo/media/doc/PSI%20Report%20-%20The%20Capital%20One%20Hack.pdf"
                        rel="noopener" target="_blank">US Senate PSI report ‚Üó</a></p>
            </div>
        </section>
        <section class="card" id="section-9-1">
            <div class="card-header">9.1 Environment &amp; Timeline</div>
            <div class="card-body">
                <p>The affected workload sat in Account A (public web tier) with:</p>
                <ul>
                    <li>WAF ‚Üí EC2 fleet running a Java microservice with overly broad instance role.</li>
                    <li>Role permissions: S3 read/write for dozens of buckets, IAM list privileges, ability to enumerate
                        KMS keys.</li>
                    <li>Trust policy:
                        <code>{ "Principal": { "Service": "ec2.amazonaws.com" }, "Action": "sts:AssumeRole" }</code> (no
                        SourceArn binding).
                    </li>
                </ul>
                <div class="widget" id="timeline-aws-role-incident"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        AppSecWidgets.TimelineVerticalView.create("timeline-aws-role-incident", {
                            title: "üïí Timeline ‚Äì Metadata Credential Theft",
                            events: [
                                {
                                    date: "2018-11-30",
                                    title: "Legacy role reused",
                                    description: "Instance profile granted admin-level S3/IAM access to simplify operations.",
                                    tags: ["IAM", "Privilege Misuse", "Legacy Systems"]
                                },
                                {
                                    date: "2019-03-22",
                                    title: "SSRF introduced",
                                    description: "WAF rule set update allowed attacker-controlled host header leading to SSRF.",
                                    tags: ["SSRF", "WAF", "Misconfiguration"]
                                },
                                {
                                    date: "2019-04-21",
                                    title: "Role credentials exfiltrated",
                                    description: "Attacker queried IMDSv1, received temporary credentials, and listed S3 buckets.",
                                    tags: ["IMDSv1", "Credential Theft", "S3 Exposure"]
                                },
                                {
                                    date: "2019-07-17",
                                    title: "Detection & response",
                                    description: "Bank identified unusual CloudTrail events and rotated roles, enabling IMDSv2.",
                                    tags: ["CloudTrail", "Incident Response", "Remediation"]
                                }
                            ]
                        });
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-9-2">
            <div class="card-header">9.2 Attack Chain</div>
            <div class="card-body">
                <p>The attacker chained three weaknesses:</p>
                <ol>
                    <li>Exploit SSRF in the WAF to reach IMDSv1 without session token requirements.</li>
                    <li>Steal the EC2 role credentials and enumerate S3, IAM, and KMS APIs.</li>
                    <li>Copy sensitive data to attacker-controlled buckets and cover tracks by disabling CloudWatch
                        alarms.</li>
                </ol>
                <pre>
[Internet] ‚Üí [WAF SSRF] ‚Üí [IMDSv1 169.254.169.254]
                                |
                                v
                         [STS Credentials]
                                |
                                v
                   [S3 Buckets / IAM / KMS APIs]
        </pre>
                <p class="callout callout-danger">Because the trust policy lacked <code>aws:SourceAccount</code> or
                    <code>aws:SourceArn</code>,
                    any EC2 resource in the account could assume the role, and IMDSv1 exposed those credentials to SSRF.
                </p>
            </div>
        </section>
        <section class="card" id="section-9-3">
            <div class="card-header">9.3 Forensics &amp; Remediation</div>
            <div class="card-body">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Signal</th>
                                <th>What Investigators Saw</th>
                                <th>Resulting Control</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>CloudTrail</td>
                                <td>Bulk <code>ListBuckets</code> and <code>GetObject</code> calls from unusual TOR exit
                                    nodes.</td>
                                <td>Enabled GuardDuty anomaly alerts + per-bucket access logging.</td>
                            </tr>
                            <tr>
                                <td>VPC Flow Logs</td>
                                <td>Internal calls to IMDS every few seconds from the WAF subnet.</td>
                                <td>Mandated IMDSv2 and blocked metadata IP at WAF layer.</td>
                            </tr>
                            <tr>
                                <td>IAM Role Inventory</td>
                                <td>Same role attached to dozens of ASGs.</td>
                                <td>Created workload-specific roles and attached permission boundaries.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p>Remediation required rotating all exposed roles, encrypting exfiltrated buckets with new keys, and
                    backfilling audit
                    trails for regulators.</p>
            </div>
        </section>
        <section class="card" id="section-9-4">
            <div class="card-header">9.4 Lessons for Reviewers</div>
            <div class="card-body">
                <ul>
                    <li>Never reuse ‚Äúcatch-all‚Äù roles; each workload needs scoped trust and permissions.</li>
                    <li>Block IMDSv1 and require hop-by-hop metadata tokens so SSRF cannot harvest credentials.</li>
                    <li>Instrument CloudTrail + GuardDuty alerts for <code>AssumeRole</code> spikes and strange source
                        IPs.</li>
                    <li>Run IAM Access Analyzer to detect public or cross-account principals regularly.</li>
                </ul>
            </div>
        </section>
        <section class="card" id="section-9-5">
            <div class="card-header">9.5 Knowledge Check</div>
            <div class="card-body">
                <div class="widget" id="quiz-aws-roles-incident"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                            AppSecWidgets.Quiz.create("quiz-aws-roles-incident", {
                                title: "üö® Incident Response Quiz",
                                questions: [
                                    {
                                        text: "Why did IMDSv1 make the Capital One-style breach easier?",
                                        options: [
                                            { value: "a", label: "It encrypts credentials in transit", correct: false },
                                            { value: "b", label: "It requires no session token, so SSRF can read credentials", correct: true },
                                            { value: "c", label: "It blocks metadata calls from WAF instances", correct: false },
                                            { value: "d", label: "It automatically rotates IAM permissions", correct: false }
                                        ]
                                    },
                                    {
                                        text: "Which trust-policy condition would have limited the blast radius?",
                                        options: [
                                            { value: "a", label: "aws:SourceArn tied to the specific Auto Scaling Group", correct: true },
                                            { value: "b", label: "Allowing principal '*'", correct: false },
                                            { value: "c", label: "Removing all conditions", correct: false },
                                            { value: "d", label: "Granting iam:CreateUser", correct: false }
                                        ]
                                    }
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-10">
            <div class="card-header">10. Threat Model ‚Äì Multi-Account Workload Identities</div>
            <div class="card-body">
                <p>This section constructs a STRIDE threat model for the three-account pipeline introduced earlier
                    (ingest, processing,
                    centralized security). Use it as a reusable reviewer checklist.</p>
            </div>
        </section>
        <section class="card" id="section-10-1">
            <div class="card-header">10.1 System Context</div>
            <div class="card-body">
                <pre>
Account A (Edge)        Account B (Processing)       Account C (Security)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ API Gateway ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂  ‚îÇ Lambda Ingestor  ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂  ‚îÇ Security Tooling     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ EC2 Batch Fleet  ‚îÇ         ‚îÇ (Analyzer, GuardDuty) ‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        </pre>
                <ul>
                    <li><strong>Assets:</strong> inbound documents, DynamoDB tables, IAM roles, SIEM audit data.</li>
                    <li><strong>Trust boundaries:</strong> cross-account role assumptions (A ‚Üí B), vendor integrations
                        via OIDC, IRSA tokens.</li>
                    <li><strong>Entry points:</strong> API Gateway, SNS topics, IMDS endpoints, CI/CD pipelines
                        deploying roles.</li>
                </ul>
            </div>
        </section>
        <section class="card" id="section-10-2">
            <div class="card-header">10.2 Threat Modeling Canvas</div>
            <div class="card-body">
                <div class="widget" id="threatmodel-aws-service-roles"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.ThreatModel) {
                            AppSecWidgets.ThreatModel.create("threatmodel-aws-service-roles", {
                                system: {
                                    name: "Event-Driven Data Platform",
                                    type: "API Gateway + Lambda + EC2 across three AWS accounts",
                                    actors: "Public API clients, Lambda services, EC2 batch workers, security tooling",
                                    assets: "Customer uploads, DynamoDB state, IAM roles, CloudTrail logs",
                                    entryPoints: "API Gateway endpoints, SNS topics, IMDS endpoints, CI/CD role deployments",
                                    boundaries: "Account A (public), Account B (processing), Account C (security tooling)"
                                },
                                stride: {
                                    spoofing: "Malicious workloads assuming roles via overly broad trust policies or leaked OIDC providers.",
                                    tampering: "Compromised Lambda modifies DynamoDB or S3 objects beyond scope if permissions are wildcards.",
                                    repudiation: "Lack of CloudTrail/CloudWatch log integrity lets attackers deny abusing AssumeRole.",
                                    information: "IMDSv1 or Secrets Manager access exposes PII and signing keys.",
                                    dos: "Attackers disable IAM Access Analyzer or flood role assumption to exhaust STS rate limits.",
                                    elevation: "Privilege escalation via attaching AdministratorAccess policy to Lambda roles through iam:PutRolePolicy."
                                }
                            }, { title: "üß† STRIDE for AWS Service Roles" });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-10-3">
            <div class="card-header">10.3 Abuse Paths &amp; Mitigations</div>
            <div class="card-body">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Threat</th>
                                <th>Abuse Pattern</th>
                                <th>Mitigation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Spoofing</td>
                                <td>Forged OIDC token from compromised CI system assumes deployment role.</td>
                                <td>Pin <code>aud</code>/<code>sub</code> claims, require <code>sts:ExternalId</code>,
                                    monitor AssumeRoleWithWebIdentity.</td>
                            </tr>
                            <tr>
                                <td>Tampering</td>
                                <td>Lambda with <code>Action: "*"</code> edits security account logs.</td>
                                <td>Permission boundaries + SCPs denying log deletion, CloudTrail log file validation.
                                </td>
                            </tr>
                            <tr>
                                <td>Information Disclosure</td>
                                <td>SSRF to IMDSv1 leaks EC2 role credentials containing Secrets Manager read rights.
                                </td>
                                <td>IMDSv2 enforcement, rotate secrets with AWS Secrets Manager automatic rotation.</td>
                            </tr>
                            <tr>
                                <td>Elevation of Privilege</td>
                                <td>Instance profile with <code>iam:PassRole</code> launches ECS tasks with
                                    higher-privilege roles.</td>
                                <td>Deny <code>iam:PassRole</code> except to deployment roles, require approval
                                    workflows.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        <section class="card" id="section-10-4">
            <div class="card-header">10.4 Knowledge Check</div>
            <div class="card-body">
                <div class="widget" id="quiz-aws-roles-threatmodel"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                            AppSecWidgets.Quiz.create("quiz-aws-roles-threatmodel", {
                                title: "üéØ Threat Modeling Quiz",
                                questions: [
                                    {
                                        text: "Which STRIDE category captures IMDS credential theft?",
                                        options: [
                                            { value: "a", label: "Information Disclosure", correct: true },
                                            { value: "b", label: "Spoofing", correct: false },
                                            { value: "c", label: "Denial of Service", correct: false },
                                            { value: "d", label: "Repudiation", correct: false }
                                        ]
                                    },
                                    {
                                        text: "What boundary should you enforce when a CI system assumes a deployment role?",
                                        options: [
                                            { value: "a", label: "None ‚Äì CI always trusted", correct: false },
                                            { value: "b", label: "Require <code>sts:ExternalId</code> and restrict GitHub OIDC audiences", correct: true },
                                            { value: "c", label: "Allow principal '*'", correct: false },
                                            { value: "d", label: "Disable CloudTrail", correct: false }
                                        ]
                                    }
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-11">
            <div class="card-header">11. Compliance Mapping</div>
            <div class="card-body">
                <p>Service roles tie identity, logging, and least privilege together, so they intersect multiple
                    frameworks. The mappings
                    below highlight specific clauses reviewers should cite during audits.</p>
            </div>
        </section>
        <section class="card" id="section-11-1">
            <div class="card-header">11.1 Framework Coverage</div>
            <div class="card-body">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Framework</th>
                                <th>Relevant Clauses</th>
                                <th>Service Role Evidence</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ISO/IEC 27001</td>
                                <td>A.9.2.3 (Management of privileged access rights), A.12.4 (Logging)</td>
                                <td>Role inventory, trust policy reviews, CloudTrail proving administrative actions are
                                    logged.</td>
                            </tr>
                            <tr>
                                <td>NIST SP 800-53</td>
                                <td>AC-2, AC-6, IA-2, AU-12</td>
                                <td>Evidence of least-privilege IAM policies, STS session durations, audit log
                                    retention.</td>
                            </tr>
                            <tr>
                                <td>PCI DSS 4.0</td>
                                <td>Requirement 7 (least privilege), Requirement 10 (log monitoring)</td>
                                <td>Scoped Lambda/EC2 roles for cardholder workloads and GuardDuty/CloudWatch alerts
                                    feeding SIEM.</td>
                            </tr>
                            <tr>
                                <td>HIPAA</td>
                                <td>¬ß164.308(a)(3) Workforce Security, ¬ß164.312(a) Access Control</td>
                                <td>Documented role-based access to ePHI buckets/DynamoDB, automatic credential rotation
                                    via STS.</td>
                            </tr>
                            <tr>
                                <td>GDPR</td>
                                <td>Article 32 (Security of processing)</td>
                                <td>Demonstrate data minimization through least-privilege roles and breach detection
                                    controls.</td>
                            </tr>
                            <tr>
                                <td>SOC 2</td>
                                <td>CC6.1, CC6.6, CC7.2</td>
                                <td>Control narratives showing change management for roles, monitoring of anomalous
                                    AssumeRole calls.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        <section class="card" id="section-11-2">
            <div class="card-header">11.2 Evidence Package</div>
            <div class="card-body">
                <ul>
                    <li>Export from IAM Access Analyzer proving no public or cross-account roles exist without
                        approvals.</li>
                    <li>CloudTrail digest validation outputs showing tamper-evident logs.</li>
                    <li>Change management tickets for each new Lambda/EC2 role with reviewer sign-off.</li>
                    <li>Proof of IMDSv2 enforcement (AWS Config rule results) on EC2 fleets handling regulated data.
                    </li>
                </ul>
            </div>
        </section>
        <section class="card" id="section-11-3">
            <div class="card-header">11.3 Automation &amp; Audit Checklist</div>
            <div class="card-body">
                <div class="widget" id="checklist-aws-compliance"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.Checklist) {
                            AppSecWidgets.Checklist.create("checklist-aws-compliance", {
                                title: "üìã Compliance Automation Tasks",
                                items: [
                                    "Daily IAM Access Analyzer scan exported to evidence bucket",
                                    "GuardDuty + Security Hub findings triaged within SLA",
                                    "AWS Config rule enforcing IMDSv2 passes for EC2 instances",
                                    "STS session duration policy documented for auditors",
                                    "Automated report of roles with AdministratorAccess policy"
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <section class="card" id="section-11-4">
            <div class="card-header">11.4 Knowledge Check</div>
            <div class="card-body">
                <div class="widget" id="quiz-aws-roles-compliance"></div>
                <script>
                    document.addEventListener("DOMContentLoaded", function () {
                        if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                            AppSecWidgets.Quiz.create("quiz-aws-roles-compliance", {
                                title: "‚úÖ Compliance Quiz",
                                questions: [
                                    {
                                        text: "Which framework explicitly calls for least-privilege account management (AC-6)?",
                                        options: [
                                            { value: "a", label: "NIST SP 800-53", correct: true },
                                            { value: "b", label: "PCI DSS 4.0 Requirement 12", correct: false },
                                            { value: "c", label: "GDPR Article 5", correct: false },
                                            { value: "d", label: "SOC 2 CC8", correct: false }
                                        ]
                                    },
                                    {
                                        text: "What evidence best proves IMDSv2 enforcement for HIPAA workloads?",
                                        options: [
                                            { value: "a", label: "CloudFront distribution config", correct: false },
                                            { value: "b", label: "AWS Config compliance report showing IMDSv2 = required", correct: true },
                                            { value: "c", label: "A screenshot of a Lambda console", correct: false },
                                            { value: "d", label: "S3 bucket policy for public hosting", correct: false }
                                        ]
                                    }
                                ]
                            });
                        }
                    });
                </script>
            </div>
        </section>
        <footer style="text-align:center; margin-top: 2rem; color: var(--text-muted); font-size: 0.85rem;">
            Daily AppSec Study ¬∑ Lesson 13 ¬∑ AWS Service Roles ‚Äì Hardened Workload Identities
        </footer>
    </div>
    <script src="appsec-theme.js"></script>
    <script src="appsec-widgets.js"></script>
</body>

</html>