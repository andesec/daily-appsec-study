<section class="card" id="section-9">
    <div class="card-header">9. Incident Case Study ‚Äì Capital One-Style Metadata Theft</div>
    <div class="card-body">
        <p>
            The 2019 Capital One breach illustrates how <strong>one misconfigured IAM role</strong> plus legacy IMDSv1 exposed
            millions of records. A WAF with an SSRF bug could query <code>169.254.169.254</code>, steal the EC2 instance profile
            credentials, and replay them across AWS services because the trust policy allowed broad assumption and the role held
            administrative permissions. The subsections break down the environment, timeline, attack chain, and remediation
            artifacts AppSec reviewers should internalize.
        </p>
        <p><a href="https://www.dhs.gov/sites/default/files/publications/19_1220_cisa_capital-one-cloud-breach-analysis.pdf" target="_blank" rel="noopener">CISA analysis ‚Üó</a>
            ¬∑ <a href="https://www.senate.gov/imo/media/doc/PSI%20Report%20-%20The%20Capital%20One%20Hack.pdf" target="_blank" rel="noopener">US Senate PSI report ‚Üó</a></p>
    </div>
</section>

<section class="card" id="section-9-1">
    <div class="card-header">9.1 Environment &amp; Timeline</div>
    <div class="card-body">
        <p>The affected workload sat in Account A (public web tier) with:</p>
        <ul>
            <li>WAF ‚Üí EC2 fleet running a Java microservice with overly broad instance role.</li>
            <li>Role permissions: S3 read/write for dozens of buckets, IAM list privileges, ability to enumerate KMS keys.</li>
            <li>Trust policy: <code>{ "Principal": { "Service": "ec2.amazonaws.com" }, "Action": "sts:AssumeRole" }</code> (no SourceArn binding).</li>
        </ul>
        <div id="timeline-aws-role-incident" class="widget"></div>
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (window.AppSecWidgets && AppSecWidgets.VulnerabilityTimeline) {
                AppSecWidgets.VulnerabilityTimeline.create("timeline-aws-role-incident", {
                    title: "üïí Timeline ‚Äì Metadata Credential Theft",
                    vulnerabilities: [
                        {
                            id: "IMDS-2018-01",
                            date: "2018-11-30",
                            title: "Legacy role reused",
                            description: "Instance profile granted admin-level S3/IAM access to simplify operations.",
                            severity: "Medium"
                        },
                        {
                            id: "IMDS-2019-02",
                            date: "2019-03-22",
                            title: "SSRF introduced",
                            description: "WAF rule set update allowed attacker-controlled host header leading to SSRF.",
                            severity: "High"
                        },
                        {
                            id: "IMDS-2019-03",
                            date: "2019-04-21",
                            title: "Role credentials exfiltrated",
                            description: "Attacker queried IMDSv1, received temporary credentials, and listed S3 buckets.",
                            severity: "Critical"
                        },
                        {
                            id: "IMDS-2019-04",
                            date: "2019-07-17",
                            title: "Detection &amp; response",
                            description: "Bank identified unusual CloudTrail events and rotated roles, enabling IMDSv2.",
                            severity: "High"
                        }
                    ],
                    placeholder: "Timeline of the role misconfiguration and breach response."
                });
            }
        });
        </script>
    </div>
</section>

<section class="card" id="section-9-2">
    <div class="card-header">9.2 Attack Chain</div>
    <div class="card-body">
        <p>The attacker chained three weaknesses:</p>
        <ol>
            <li>Exploit SSRF in the WAF to reach IMDSv1 without session token requirements.</li>
            <li>Steal the EC2 role credentials and enumerate S3, IAM, and KMS APIs.</li>
            <li>Copy sensitive data to attacker-controlled buckets and cover tracks by disabling CloudWatch alarms.</li>
        </ol>
        <pre>
[Internet] ‚Üí [WAF SSRF] ‚Üí [IMDSv1 169.254.169.254]
                                |
                                v
                         [STS Credentials]
                                |
                                v
                   [S3 Buckets / IAM / KMS APIs]
        </pre>
        <p class="callout callout-danger">Because the trust policy lacked <code>aws:SourceAccount</code> or <code>aws:SourceArn</code>,
            any EC2 resource in the account could assume the role, and IMDSv1 exposed those credentials to SSRF.</p>
    </div>
</section>

<section class="card" id="section-9-3">
    <div class="card-header">9.3 Forensics &amp; Remediation</div>
    <div class="card-body">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Signal</th>
                        <th>What Investigators Saw</th>
                        <th>Resulting Control</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>CloudTrail</td>
                        <td>Bulk <code>ListBuckets</code> and <code>GetObject</code> calls from unusual TOR exit nodes.</td>
                        <td>Enabled GuardDuty anomaly alerts + per-bucket access logging.</td>
                    </tr>
                    <tr>
                        <td>VPC Flow Logs</td>
                        <td>Internal calls to IMDS every few seconds from the WAF subnet.</td>
                        <td>Mandated IMDSv2 and blocked metadata IP at WAF layer.</td>
                    </tr>
                    <tr>
                        <td>IAM Role Inventory</td>
                        <td>Same role attached to dozens of ASGs.</td>
                        <td>Created workload-specific roles and attached permission boundaries.</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <p>Remediation required rotating all exposed roles, encrypting exfiltrated buckets with new keys, and backfilling audit
            trails for regulators.</p>
    </div>
</section>

<section class="card" id="section-9-4">
    <div class="card-header">9.4 Lessons for Reviewers</div>
    <div class="card-body">
        <ul>
            <li>Never reuse ‚Äúcatch-all‚Äù roles; each workload needs scoped trust and permissions.</li>
            <li>Block IMDSv1 and require hop-by-hop metadata tokens so SSRF cannot harvest credentials.</li>
            <li>Instrument CloudTrail + GuardDuty alerts for <code>AssumeRole</code> spikes and strange source IPs.</li>
            <li>Run IAM Access Analyzer to detect public or cross-account principals regularly.</li>
        </ul>
    </div>
</section>

<section class="card" id="section-9-5">
    <div class="card-header">9.5 Knowledge Check</div>
    <div class="card-body">
        <div id="quiz-aws-roles-incident" class="widget"></div>
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                AppSecWidgets.Quiz.create("quiz-aws-roles-incident", {
                    title: "üö® Incident Response Quiz",
                    questions: [
                        {
                            text: "Why did IMDSv1 make the Capital One-style breach easier?",
                            options: [
                                { value: "a", label: "It encrypts credentials in transit", correct: false },
                                { value: "b", label: "It requires no session token, so SSRF can read credentials", correct: true },
                                { value: "c", label: "It blocks metadata calls from WAF instances", correct: false },
                                { value: "d", label: "It automatically rotates IAM permissions", correct: false }
                            ]
                        },
                        {
                            text: "Which trust-policy condition would have limited the blast radius?",
                            options: [
                                { value: "a", label: "aws:SourceArn tied to the specific Auto Scaling Group", correct: true },
                                { value: "b", label: "Allowing principal '*'", correct: false },
                                { value: "c", label: "Removing all conditions", correct: false },
                                { value: "d", label: "Granting iam:CreateUser", correct: false }
                            ]
                        }
                    ]
                });
            }
        });
        </script>
    </div>
</section>

<section class="card" id="section-10">
    <div class="card-header">10. Threat Model ‚Äì Multi-Account Workload Identities</div>
    <div class="card-body">
        <p>This section constructs a STRIDE threat model for the three-account pipeline introduced earlier (ingest, processing,
            centralized security). Use it as a reusable reviewer checklist.</p>
    </div>
</section>

<section class="card" id="section-10-1">
    <div class="card-header">10.1 System Context</div>
    <div class="card-body">
        <pre>
Account A (Edge)        Account B (Processing)       Account C (Security)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ API Gateway ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂  ‚îÇ Lambda Ingestor  ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂  ‚îÇ Security Tooling     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ EC2 Batch Fleet  ‚îÇ         ‚îÇ (Analyzer, GuardDuty) ‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        </pre>
        <ul>
            <li><strong>Assets:</strong> inbound documents, DynamoDB tables, IAM roles, SIEM audit data.</li>
            <li><strong>Trust boundaries:</strong> cross-account role assumptions (A ‚Üí B), vendor integrations via OIDC, IRSA tokens.</li>
            <li><strong>Entry points:</strong> API Gateway, SNS topics, IMDS endpoints, CI/CD pipelines deploying roles.</li>
        </ul>
    </div>
</section>

<section class="card" id="section-10-2">
    <div class="card-header">10.2 Threat Modeling Canvas</div>
    <div class="card-body">
        <div id="threatmodel-aws-service-roles" class="widget"></div>
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (window.AppSecWidgets && AppSecWidgets.ThreatModel) {
                AppSecWidgets.ThreatModel.create("threatmodel-aws-service-roles", {
                    system: {
                        name: "Event-Driven Data Platform",
                        type: "API Gateway + Lambda + EC2 across three AWS accounts",
                        actors: "Public API clients, Lambda services, EC2 batch workers, security tooling",
                        assets: "Customer uploads, DynamoDB state, IAM roles, CloudTrail logs",
                        entryPoints: "API Gateway endpoints, SNS topics, IMDS endpoints, CI/CD role deployments",
                        boundaries: "Account A (public), Account B (processing), Account C (security tooling)"
                    },
                    stride: {
                        spoofing: "Malicious workloads assuming roles via overly broad trust policies or leaked OIDC providers.",
                        tampering: "Compromised Lambda modifies DynamoDB or S3 objects beyond scope if permissions are wildcards.",
                        repudiation: "Lack of CloudTrail/CloudWatch log integrity lets attackers deny abusing AssumeRole.",
                        information: "IMDSv1 or Secrets Manager access exposes PII and signing keys.",
                        dos: "Attackers disable IAM Access Analyzer or flood role assumption to exhaust STS rate limits.",
                        elevation: "Privilege escalation via attaching AdministratorAccess policy to Lambda roles through iam:PutRolePolicy."
                    }
                }, { title: "üß† STRIDE for AWS Service Roles" });
            }
        });
        </script>
    </div>
</section>

<section class="card" id="section-10-3">
    <div class="card-header">10.3 Abuse Paths &amp; Mitigations</div>
    <div class="card-body">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Threat</th>
                        <th>Abuse Pattern</th>
                        <th>Mitigation</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Spoofing</td>
                        <td>Forged OIDC token from compromised CI system assumes deployment role.</td>
                        <td>Pin <code>aud</code>/<code>sub</code> claims, require <code>sts:ExternalId</code>, monitor AssumeRoleWithWebIdentity.</td>
                    </tr>
                    <tr>
                        <td>Tampering</td>
                        <td>Lambda with <code>Action: "*"</code> edits security account logs.</td>
                        <td>Permission boundaries + SCPs denying log deletion, CloudTrail log file validation.</td>
                    </tr>
                    <tr>
                        <td>Information Disclosure</td>
                        <td>SSRF to IMDSv1 leaks EC2 role credentials containing Secrets Manager read rights.</td>
                        <td>IMDSv2 enforcement, rotate secrets with AWS Secrets Manager automatic rotation.</td>
                    </tr>
                    <tr>
                        <td>Elevation of Privilege</td>
                        <td>Instance profile with <code>iam:PassRole</code> launches ECS tasks with higher-privilege roles.</td>
                        <td>Deny <code>iam:PassRole</code> except to deployment roles, require approval workflows.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</section>

<section class="card" id="section-10-4">
    <div class="card-header">10.4 Knowledge Check</div>
    <div class="card-body">
        <div id="quiz-aws-roles-threatmodel" class="widget"></div>
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                AppSecWidgets.Quiz.create("quiz-aws-roles-threatmodel", {
                    title: "üéØ Threat Modeling Quiz",
                    questions: [
                        {
                            text: "Which STRIDE category captures IMDS credential theft?",
                            options: [
                                { value: "a", label: "Information Disclosure", correct: true },
                                { value: "b", label: "Spoofing", correct: false },
                                { value: "c", label: "Denial of Service", correct: false },
                                { value: "d", label: "Repudiation", correct: false }
                            ]
                        },
                        {
                            text: "What boundary should you enforce when a CI system assumes a deployment role?",
                            options: [
                                { value: "a", label: "None ‚Äì CI always trusted", correct: false },
                                { value: "b", label: "Require <code>sts:ExternalId</code> and restrict GitHub OIDC audiences", correct: true },
                                { value: "c", label: "Allow principal '*'", correct: false },
                                { value: "d", label: "Disable CloudTrail", correct: false }
                            ]
                        }
                    ]
                });
            }
        });
        </script>
    </div>
</section>

<section class="card" id="section-11">
    <div class="card-header">11. Compliance Mapping</div>
    <div class="card-body">
        <p>Service roles tie identity, logging, and least privilege together, so they intersect multiple frameworks. The mappings
            below highlight specific clauses reviewers should cite during audits.</p>
    </div>
</section>

<section class="card" id="section-11-1">
    <div class="card-header">11.1 Framework Coverage</div>
    <div class="card-body">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Framework</th>
                        <th>Relevant Clauses</th>
                        <th>Service Role Evidence</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>ISO/IEC 27001</td>
                        <td>A.9.2.3 (Management of privileged access rights), A.12.4 (Logging)</td>
                        <td>Role inventory, trust policy reviews, CloudTrail proving administrative actions are logged.</td>
                    </tr>
                    <tr>
                        <td>NIST SP 800-53</td>
                        <td>AC-2, AC-6, IA-2, AU-12</td>
                        <td>Evidence of least-privilege IAM policies, STS session durations, audit log retention.</td>
                    </tr>
                    <tr>
                        <td>PCI DSS 4.0</td>
                        <td>Requirement 7 (least privilege), Requirement 10 (log monitoring)</td>
                        <td>Scoped Lambda/EC2 roles for cardholder workloads and GuardDuty/CloudWatch alerts feeding SIEM.</td>
                    </tr>
                    <tr>
                        <td>HIPAA</td>
                        <td>¬ß164.308(a)(3) Workforce Security, ¬ß164.312(a) Access Control</td>
                        <td>Documented role-based access to ePHI buckets/DynamoDB, automatic credential rotation via STS.</td>
                    </tr>
                    <tr>
                        <td>GDPR</td>
                        <td>Article 32 (Security of processing)</td>
                        <td>Demonstrate data minimization through least-privilege roles and breach detection controls.</td>
                    </tr>
                    <tr>
                        <td>SOC 2</td>
                        <td>CC6.1, CC6.6, CC7.2</td>
                        <td>Control narratives showing change management for roles, monitoring of anomalous AssumeRole calls.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</section>

<section class="card" id="section-11-2">
    <div class="card-header">11.2 Evidence Package</div>
    <div class="card-body">
        <ul>
            <li>Export from IAM Access Analyzer proving no public or cross-account roles exist without approvals.</li>
            <li>CloudTrail digest validation outputs showing tamper-evident logs.</li>
            <li>Change management tickets for each new Lambda/EC2 role with reviewer sign-off.</li>
            <li>Proof of IMDSv2 enforcement (AWS Config rule results) on EC2 fleets handling regulated data.</li>
        </ul>
    </div>
</section>

<section class="card" id="section-11-3">
    <div class="card-header">11.3 Automation &amp; Audit Checklist</div>
    <div class="card-body">
        <div id="checklist-aws-compliance" class="widget"></div>
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (window.AppSecWidgets && AppSecWidgets.Checklist) {
                AppSecWidgets.Checklist.create("checklist-aws-compliance", {
                    title: "üìã Compliance Automation Tasks",
                    items: [
                        "Daily IAM Access Analyzer scan exported to evidence bucket",
                        "GuardDuty + Security Hub findings triaged within SLA",
                        "AWS Config rule enforcing IMDSv2 passes for EC2 instances",
                        "STS session duration policy documented for auditors",
                        "Automated report of roles with AdministratorAccess policy"
                    ]
                });
            }
        });
        </script>
    </div>
</section>

<section class="card" id="section-11-4">
    <div class="card-header">11.4 Knowledge Check</div>
    <div class="card-body">
        <div id="quiz-aws-roles-compliance" class="widget"></div>
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                AppSecWidgets.Quiz.create("quiz-aws-roles-compliance", {
                    title: "‚úÖ Compliance Quiz",
                    questions: [
                        {
                            text: "Which framework explicitly calls for least-privilege account management (AC-6)?",
                            options: [
                                { value: "a", label: "NIST SP 800-53", correct: true },
                                { value: "b", label: "PCI DSS 4.0 Requirement 12", correct: false },
                                { value: "c", label: "GDPR Article 5", correct: false },
                                { value: "d", label: "SOC 2 CC8", correct: false }
                            ]
                        },
                        {
                            text: "What evidence best proves IMDSv2 enforcement for HIPAA workloads?",
                            options: [
                                { value: "a", label: "CloudFront distribution config", correct: false },
                                { value: "b", label: "AWS Config compliance report showing IMDSv2 = required", correct: true },
                                { value: "c", label: "A screenshot of a Lambda console", correct: false },
                                { value: "d", label: "S3 bucket policy for public hosting", correct: false }
                            ]
                        }
                    ]
                });
            }
        });
        </script>
    </div>
</section>
