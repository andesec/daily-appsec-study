<section class="card" id="section-3">
    <div class="card-header">3. Mental Model ‚Äî Why ‚Üí How ‚Üí What-If</div>
    <div class="card-body">
        <p>
            A strong AWS identity mental model layers business drivers (why roles exist), platform mechanics (how trust is
            granted and enforced), and failure scenarios (what happens when configurations drift). This overview aligns all three
            before you drill into the subsections.
        </p>
    </div>
</section>

<section class="card" id="section-3-1">
    <div class="card-header">3.1 WHY Roles Matter</div>
    <div class="card-body">
        <ol>
            <li>
                <strong>Eliminate long-lived credentials.</strong>
                Access keys leak through repos, screenshots, logs, CI artifacts, and rarely expire. Roles issue STS credentials
                that die on schedule, so attackers can‚Äôt persist.
            </li>
            <li>
                <strong>Enforce isolation across services.</strong>
                Each workload (Lambda, EC2, ECS, Glue, Step Functions) receives a bespoke role. Compromising ingestion Lambda no
                longer grants permission to modify DynamoDB or Secrets Manager used by unrelated services.
            </li>
            <li>
                <strong>Support cross-account security patterns.</strong>
                Multi-account setups (dev ‚Üí staging ‚Üí prod, centralized security tooling, vendor integrations) are safe because
                trust policies explicitly list which account or service may assume the role.
            </li>
        </ol>
        <p><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html" target="_blank" rel="noopener">AWS IAM
                best practices ‚Üó</a></p>
    </div>
</section>

<section class="card" id="section-3-2">
    <div class="card-header">3.2 HOW AWS Roles Work Internally</div>
    <div class="card-body">
        <h4>A. Service ‚Üí Control Plane ‚Üí STS ‚Üí Credentials</h4>
        <ol>
            <li>Workload (Lambda invocation, EC2 boot, ECS task) triggers the AWS control plane.</li>
            <li>The control plane evaluates the role‚Äôs <strong>trust policy</strong>.</li>
            <li>If allowed, AWS STS issues short-lived credentials for that role.</li>
            <li>Credentials are delivered through environment variables (Lambda), IMDSv2 (EC2), ECS task metadata, or EKS IRSA web identity tokens.</li>
            <li>The AWS SDK in the workload signs requests using those credentials.</li>
        </ol>
        <h4>B. Permissions Evaluated on Every Request</h4>
        <ol>
            <li>Temporary credentials reference the role‚Äôs permissions policy.</li>
            <li>Service-linked permissions and resource policies (S3 buckets, KMS keys) further scope access.</li>
            <li>Permission boundaries or Service Control Policies (SCPs) may deny actions even if the role allows them.</li>
            <li>The request is allowed only if <em>every</em> relevant policy permits it.</li>
        </ol>
        <p><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_evaluation-logic.html" target="_blank"
                rel="noopener">IAM evaluation logic ‚Üó</a></p>
    </div>
</section>

<section class="card" id="section-3-3">
    <div class="card-header">3.3 WHAT-IF Scenarios</div>
    <div class="card-body">
        <div class="callout callout-warning">
            <strong>Misconfigured trust or permissions translate directly into compromised identities.</strong> Keep these scenarios in your review checklist.
        </div>
        <ul>
            <li>
                <strong>Trust policy is too broad.</strong>
                <pre><code class="language-json">"Principal": "*"</code></pre>
                Any AWS principal can assume the role, enabling trivial cross-account takeovers.
            </li>
            <li>
                <strong>Lambda role has <code>Action: "*"</code>.</strong>
                A simple RCE in Lambda becomes full-account compromise (create IAM users, delete logs, exfiltrate data).
            </li>
            <li>
                <strong>EC2 uses IMDSv1.</strong>
                SSRF attackers can query metadata without a session token and steal credentials. This is the Capital One breach pattern. <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html" target="_blank" rel="noopener">IMDSv2 hardening guide ‚Üó</a>
            </li>
            <li>
                <strong>Cross-account role lacks <code>sts:ExternalId</code>.</strong>
                Malicious accounts impersonate trusted vendors (confused deputy attack).
            </li>
        </ul>
    </div>
</section>

<section class="card" id="section-3-4">
    <div class="card-header">3.4 Knowledge Check</div>
    <div class="card-body">
        <div id="quiz-aws-roles-mental" class="widget"></div>
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                AppSecWidgets.Quiz.create("quiz-aws-roles-mental", {
                    title: "üß≠ Mental Model Quiz",
                    questions: [
                        {
                            text: "Which step happens first when Lambda invokes an AWS API?",
                            options: [
                                { value: "a", label: "Lambda runtime generates its own credentials", correct: false },
                                { value: "b", label: "AWS control plane checks the role's trust policy and calls STS", correct: true },
                                { value: "c", label: "GuardDuty reviews the request", correct: false },
                                { value: "d", label: "KMS decrypts a data key", correct: false }
                            ]
                        },
                        {
                            text: "Why does a broad trust policy immediately raise a critical finding?",
                            options: [
                                { value: "a", label: "Because it reduces function concurrency", correct: false },
                                { value: "b", label: "Because any AWS principal can assume the role and pivot", correct: true },
                                { value: "c", label: "Because STS stops issuing credentials", correct: false },
                                { value: "d", label: "Because IMDSv2 disables the role", correct: false }
                            ]
                        }
                    ]
                });
            }
        });
        </script>
    </div>
</section>

<section class="card" id="section-4">
    <div class="card-header">4. Deep Explanation (Step-by-Step)</div>
    <div class="card-body">
        <p>
            This section dissects the full lifecycle of Lambda execution roles, EC2 instance profiles, and trust policy design so
            you can review them line by line.
        </p>
    </div>
</section>

<section class="card" id="section-4-1">
    <div class="card-header">4.1 Lambda Execution Role Lifecycle</div>
    <div class="card-body">
        <ol>
            <li><strong>Invocation.</strong> API Gateway, EventBridge, S3 events, or direct invoke triggers Lambda.</li>
            <li><strong>Control plane validation.</strong> AWS validates configuration and references the execution role.</li>
            <li><strong>STS assumption.</strong> Lambda service assumes the role and receives credentials.</li>
            <li><strong>Credential injection.</strong> Temporary credentials appear in environment variables and AWS SDK providers.</li>
            <li><strong>Execution.</strong> Lambda code calls AWS APIs using these permissions.</li>
            <li><strong>Expiration.</strong> Credentials expire; fresh invocations receive new ones.</li>
        </ol>
        <div class="callout callout-info">
            A Lambda with command injection gives attackers the same abilities as the execution role. Review its policies as if they were standing IAM users.
        </div>
    </div>
</section>

<section class="card" id="section-4-2">
    <div class="card-header">4.2 EC2 Instance Profile Lifecycle</div>
    <div class="card-body">
        <ol>
            <li>EC2 boots with an instance profile binding to a single IAM role.</li>
            <li>Workload sends <code>PUT</code> request to IMDSv2 to obtain a session token.</li>
            <li>Workload fetches credentials using that token:
                <pre><code>GET http://169.254.169.254/latest/meta-data/iam/security-credentials/&lt;RoleName&gt;
X-aws-ec2-metadata-token: &lt;token&gt;</code></pre>
            </li>
            <li>IMDSv2 returns temporary access key, secret, session token, and expiration.</li>
            <li>SDK refreshes automatically; developers don‚Äôt handle keys directly.</li>
        </ol>
        <table>
            <thead>
                <tr><th>Feature</th><th>IMDSv1</th><th>IMDSv2</th></tr>
            </thead>
            <tbody>
                <tr><td>Requires session token</td><td>No</td><td>Yes</td></tr>
                <tr><td>SSRF protection</td><td>Weak</td><td>Strong</td></tr>
                <tr><td>Enforced hop count</td><td>No</td><td>Yes</td></tr>
                <tr><td>Capital One exploit viable?</td><td>Yes</td><td>No</td></tr>
            </tbody>
        </table>
    </div>
</section>

<section class="card" id="section-4-3">
    <div class="card-header">4.3 Trust Policy Construction</div>
    <div class="card-body">
        <p>A trust policy states ‚ÄúThis role can be assumed by this principal, using this mechanism, under these conditions.‚Äù</p>
        <ul>
            <li><strong>Principal</strong> ‚Äì service principal, AWS account, IAM user/role, or federated IdP.</li>
            <li><strong>Action</strong> ‚Äì typically <code>sts:AssumeRole</code>.</li>
            <li><strong>Conditions</strong> ‚Äì <code>aws:SourceArn</code>, <code>aws:SourceAccount</code>, <code>sts:ExternalId</code>, <code>sts:RoleSessionName</code> for fine-grained constraints.</li>
        </ul>
        <p>Secure example for Lambda:</p>
        <pre><code class="language-json">{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Service": "lambda.amazonaws.com" },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": { "aws:SourceAccount": "123456789012" },
        "ArnLike": { "aws:SourceArn": "arn:aws:lambda:us-east-1:123456789012:function:PaymentsProcessor" }
      }
    }
  ]
}</code></pre>
    </div>
</section>

<section class="card" id="section-4-4">
    <div class="card-header">4.4 Bad vs Good Trust Policies</div>
    <div class="card-body">
        <div id="configdiff-aws-trust" class="widget"></div>
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (window.AppSecWidgets && AppSecWidgets.ConfigDiff) {
                AppSecWidgets.ConfigDiff.create(
                    "configdiff-aws-trust",
                    "üîí Trust Policy Hardening",
                    `"Principal": "*"`,
                    `{
  "Principal": { "Service": "lambda.amazonaws.com" },
  "Action": "sts:AssumeRole",
  "Condition": {
    "StringEquals": { "aws:SourceAccount": "123456789012" },
    "ArnLike": { "aws:SourceArn": "arn:aws:lambda:*:123456789012:function:Order*" }
  }
}`
                );
            }
        });
        </script>
        <p>The insecure versions remove authentication altogether; the secure policy binds both the service principal and the exact Lambda ARNs allowed to assume it.</p>
    </div>
</section>

<section class="card" id="section-4-5">
    <div class="card-header">4.5 Confused Deputy Protection with <code>sts:ExternalId</code></div>
    <div class="card-body">
        <p>
            When delegating to third-party vendors, always require a unique ExternalId so malicious AWS accounts cannot impersonate them. Vendors include this value when assuming your role, and IAM validates it before issuing credentials.
        </p>
        <p><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user_externalid.html" target="_blank" rel="noopener">AWS ExternalId guidance ‚Üó</a></p>
    </div>
</section>

<section class="card" id="section-4-6">
    <div class="card-header">4.6 Knowledge Check</div>
    <div class="card-body">
        <div id="quiz-aws-roles-deep" class="widget"></div>
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                AppSecWidgets.Quiz.create("quiz-aws-roles-deep", {
                    title: "üî¨ Deep Dive Quiz",
                    questions: [
                        {
                            text: "What is the final gating factor before Lambda code uses AWS APIs?",
                            options: [
                                { value: "a", label: "CloudWatch alarm approval", correct: false },
                                { value: "b", label: "STS credentials injected into the runtime", correct: true },
                                { value: "c", label: "Manual IAM user login", correct: false },
                                { value: "d", label: "GuardDuty suppression list update", correct: false }
                            ]
                        },
                        {
                            text: "Which condition blocks confused deputy attacks for third-party roles?",
                            options: [
                                { value: "a", label: "aws:MultiFactorAuthPresent", correct: false },
                                { value: "b", label: "sts:ExternalId", correct: true },
                                { value: "c", label: "ec2:InstanceType", correct: false },
                                { value: "d", label: "s3:ExistingObjectTag", correct: false }
                            ]
                        }
                    ]
                });
            }
        });
        </script>
    </div>
</section>
