# Lesson 13: AWS Service Roles  
## Sections 1–2 (Maximum Detail)

---

# 1. Foundations

## 1.1 Understanding IAM Roles  
IAM roles are **temporary identities** designed for workloads, not humans. Unlike IAM users, roles contain no long‑term credentials. They are assumed by AWS services or external identities through AWS STS.  
Key benefits include:

- Eliminating long-lived keys.
- Enabling least-privilege per service.
- Enforcing scoped trust boundaries.
- Supporting cross-account automation.
- Preventing credential persistence after compromise.

Roles support a broad range of AWS mechanisms:
- Lambda execution
- EC2 instance profiles
- ECS task roles
- EKS IRSA
- CloudFormation service roles
- Cross-account access for CI/CD
- Federated access via OIDC or SAML

Official AWS reference:  
https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html

---

## 1.2 AWS STS (Security Token Service): Identity Backbone  
AWS STS issues short‑lived credentials to workloads. These credentials inherit:
- Permission scope from the role’s policies.
- Lifetime defined by the role session (commonly 15 minutes–1 hour).
- Automatic rotation at expiration.

### Why It Matters  
Short-lived credentials:
- Reduce blast radius.
- Prevent credential persistence post-attack.
- Are safe to distribute to ephemeral compute (Lambda, containers).

### STS Operations Used in Workload Identity  
- `AssumeRole` — Cross-account, Lambda, EC2, ECS, most workloads.
- `AssumeRoleWithWebIdentity` — OIDC identity sources (e.g., EKS IRSA).
- `AssumeRoleWithSAML` — Enterprise SSO.
- `GetFederationToken` — Legacy, short-term federation.

STS Reference:  
https://docs.aws.amazon.com/STS/latest/APIReference/Welcome.html

---

## 1.3 The Lambda Execution Role (LER)  
Every Lambda function must have an IAM role associated with it. This role grants permissions required by the Lambda runtime and the function code.

### How Lambda Uses Its Role  
1. User or AWS service invokes Lambda.
2. Lambda service (control plane) validates the function configuration.
3. Lambda service **assumes the execution role** via STS.
4. Lambda runtime receives temporary credentials injected into:
   - Environment variables, or  
   - AWS SDK credential provider chain  
5. Lambda code executes with permissions defined in the role’s **permissions policy**.

### Typical Needs of a Lambda Role  
- Writes to CloudWatch Logs:
  - `logs:CreateLogGroup`
  - `logs:CreateLogStream`
  - `logs:PutLogEvents`
- Application-specific actions:
  - Reading S3 objects  
  - Writing to DynamoDB  
  - Publishing SNS events  
  - Using Secrets Manager or Parameter Store

### Example LER Trust Policy  
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Service": "lambda.amazonaws.com" },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

Lambda Execution Role Documentation:  
https://docs.aws.amazon.com/lambda/latest/dg/lambda-intro-execution-role.html

---

## 1.4 EC2 Instance Profiles: Role Delivery Mechanism  
EC2 cannot directly attach an IAM role. Instead, AWS uses an **instance profile**, which is effectively a wrapper containing exactly 1 role.

### Credential Flow via IMDSv2  
1. Application requests IMDSv2 session token via PUT.
2. IMDSv2 returns a session token (valid for several hours).
3. Application calls IMDSv2 again to request IAM credentials.
4. IMDSv2 returns:
   - Access key  
   - Secret key  
   - Session token  
   - Expiration  
5. SDK auto-refreshes credentials before expiration.

### Why IMDSv1 Is Dangerous  
IMDSv1 allowed HTTP GET requests without session authentication, making it vulnerable to SSRF.

Capital One exploited exactly this failure mode.

EC2 IAM Role Reference:  
https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html

---

## 1.5 Trust Policies: AWS’s Identity Firewall  
A **trust policy** defines which identities or services are allowed to assume a role.

### Key Fields  
- **Principal**  
  Who can assume the role.
- **Action**  
  Almost always `sts:AssumeRole`.
- **Condition**  
  Contextual constraints to prevent unintended assumptions.

### Commonly Used Conditions  
- `aws:SourceArn` — Bind role assumption to a specific resource.  
- `aws:SourceAccount` — Prevent cross-account resource-based exploitation.  
- `sts:ExternalId` — Mitigate “confused deputy” attacks.  
- IP conditions (`aws:SourceIp`) — Rarely used, but possible.

### Example Hardened Trust Policy  
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Service": "lambda.amazonaws.com" },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": {
          "aws:SourceAccount": "123456789012"
        },
        "ArnLike": {
          "aws:SourceArn": "arn:aws:lambda:us-east-1:123456789012:function:UserRegistration-*"
        }
      }
    }
  ]
}
```

---

# 2. Intuitive Hook: “Temporary Badges in a Secure Facility”

Think of AWS services as workers in a government research lab.

### IAM Role = Temporary Security Badge  
When a Lambda runs, AWS issues it a “security badge” (the STS credentials) with a list of:
- Doors it can open (permissions)
- Floors it can access (resource scope)
- How long the badge works (expiration time)

### Trust Policy = Security Guard at the Front Door  
The guard checks:
- Are you an AWS Lambda service?  
- Are you from the correct AWS account?  
- Is your request tied to the correct Lambda function ARN?

If the guard is sloppy:
- An attacker might get a badge.  
- Another AWS service might impersonate Lambda.  
- A rogue external role might take over the badge.

### Permissions Policy = Internal Access Rules  
Once inside, the badge indicates:
- Which labs Lambda can enter.  
- Whether Lambda can read S3 buckets.  
- Whether Lambda can alter IAM or KMS resources.

This analogy cleanly models:
- Lambda Execution Roles  
- EC2 Instance Profiles  
- Trust boundaries  
- STS credential issuance  
- Metadata service weaknesses  
- Cross-account role assumptions  
- External ID usage  

---

(End of Sections 1–2)
