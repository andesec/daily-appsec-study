
# Lesson 13: AWS Service Roles  
## Sections 3–4 (Maximum Detail)

---

# 3. Mental Model — Why → How → What-If

Understanding AWS service roles requires a strong mental model that mirrors how identity, authorization, and trust boundaries function inside AWS.

---

## 3.1 WHY Roles Matter (Security, Scalability, Zero-Trust Foundations)

AWS IAM roles exist to solve three fundamental problems:

### **1. Eliminating Long‑Lived Credentials**
Long‑term credentials (access keys) are dangerous:
- They leak through logs, repos, screenshots, CI pipelines.
- They never expire unless manually rotated.
- Attackers who obtain them gain persistent access.

Roles remove this risk entirely:
- No permanent keys.
- Temporary STS credentials only.

### **2. Enforcing Identity Isolation Across Services**
Each AWS service (Lambda, EC2, ECS, Glue, Step Functions) should operate with the minimum permissions needed.  
Roles allow strict separation:

- Ingestion Lambda only reads from one S3 bucket.
- EC2 worker only writes to DynamoDB.
- Logging agent only sends data to CloudWatch.

This prevents lateral movement if one service is compromised.

### **3. Supporting Cross‑Account Security Patterns**
Modern architectures use:
- Dev → Staging → Prod accounts
- Centralized security tooling accounts
- Vendor integrations
- Multi-tenant workloads

Roles make secure cross-account access possible through trust policies.

AWS IAM Best Practices:  
https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html

---

## 3.2 HOW AWS Roles Work Internally

Let’s break into two key dimensions:

---

### **A. Service → Control Plane → STS → Role Credentials**

When a workload uses a role, AWS does the following:

1. The service invokes the AWS control plane.
2. The control plane checks the **trust policy**.
3. If the principal is permitted:
   - AWS STS issues short-lived credentials.
4. Credentials are delivered to the workload:
   - Through environment variables (Lambda)
   - Through IMDSv2 (EC2)
   - Through ECS Task Metadata
   - Through EKS IRSA web identity tokens
5. The AWS SDK uses the credentials automatically.

---

### **B. Permissions Are Evaluated on EVERY Request**

When code calls AWS (e.g., `s3:GetObject`), IAM evaluates:

1. The temporary credentials’ permissions policy.
2. Service‑linked permissions.
3. Resource-based policies (S3 bucket, KMS key).
4. Boundary or SCP limits (if applied).

This forms a **multi-layered authorization chain**.

AWS IAM Evaluation Logic:  
https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_evaluation-logic.html

---

## 3.3 WHAT‑IF Scenarios (Bad Trust, Bad Permissions, Bad Metadata Security)

### **WHAT IF Trust Policy Is Too Broad?**
Example:
```json
"Principal": "*"
```
Outcome:
- Any AWS principal can assume the role.
- Cross-account takeover becomes trivial.
- Attackers can escalate privilege.

---

### **WHAT IF Lambda Execution Role Has Admin Permissions?**
Lambda role contains:
```json
"Action": "*"
```
Outcome:
- A simple RCE in Lambda = full AWS compromise.
- Attackers can create IAM users, delete logs, or exfiltrate data.

---

### **WHAT IF EC2 Uses IMDSv1 Instead of IMDSv2?**
IMDSv1 allows unauthenticated metadata queries.

Outcome:
- SSRF → Metadata → IAM Role Credentials → S3/DynamoDB compromise  
(Exactly what happened in the Capital One breach.)

IMDSv2 docs:  
https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html

---

### **WHAT IF Cross‑Account Roles Lack ExternalId?**
3rd‑party roles without ExternalId are vulnerable to **confused deputy** attacks.

Outcome:
- Unauthorized accounts can assume roles intended for trusted partners.

Explained by AWS:  
https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user_externalid.html

---

---

# 4. Deep Explanation (Step‑by‑Step)

This section breaks down the internals of Lambda execution roles, EC2 instance profiles, trust policies, and STS flows.

---

# 4.1 Lambda Execution Role — Full Lifecycle Breakdown

### **Step 1 — Lambda Invocation**
Events that trigger Lambda:
- API Gateway
- S3 uploads
- CloudWatch Events
- SNS messages
- Direct invocation

### **Step 2 — AWS Control Plane Assumes Role**
AWS Lambda service calls STS:
```
sts:AssumeRole(RoleArn="arn:aws:iam::1234:role/LambdaExecRole")
```

### **Step 3 — STS Issues Temporary Credentials**
STS returns:
- AccessKeyId
- SecretAccessKey
- SessionToken
- Expiration

Credentials are valid for the **duration of the function invocation**.

### **Step 4 — Lambda Runtime Injects Credentials**
Credentials appear in:
- Environment variables: `AWS_ACCESS_KEY_ID`, etc.
- AWS SDK credential resolver chain

### **Step 5 — Lambda Code Uses Permissions**
SDK automatically signs requests with STS credentials.

### **Step 6 — Credentials Expire Automatically**
No credential reuse possible.

### Example Attack Scenario  
If Lambda is vulnerable to command injection or RCE:
- Attacker gets temporary creds.
- Can access permitted AWS APIs.
- Blast radius depends on permissions.

This is why least-privilege Lambda roles matter.

---

# 4.2 EC2 Instance Profile — Full Lifecycle Breakdown

EC2 roles use **instance profiles** and **IMDSv2**.

### **Step 1 — EC2 Boot With Instance Profile**
When the instance starts, AWS binds:
```
InstanceProfile(ProfileName="WebServerProfile")
```

### **Step 2 — Workload Requests IMDSv2 Token**
Application runs:
```
PUT http://169.254.169.254/latest/api/token
Metadata-Flavor: Amazon
```

IMDSv2 returns a token.

### **Step 3 — Application Uses Token to Request Credentials**
```
GET http://169.254.169.254/latest/meta-data/iam/security-credentials/<RoleName>
X-aws-ec2-metadata-token: <token>
```

### **Step 4 — IMDSv2 Returns Temporary STS Credentials**

### **Step 5 — AWS SDK Auto-Rotates Credentials**
No developer involvement required.

---

### IMDSv1 vs IMDSv2 Summary Table

| Feature | IMDSv1 | IMDSv2 |
|--------|--------|--------|
| Requires session token | No | Yes |
| SSRF protection | Weak | Strong |
| Enforced hop count | No | Yes |
| Vulnerable to Capital One exploit | Yes | No |

---

# 4.3 Trust Policy Construction — Deep Dive

Trust policies are the **core of AWS identity boundaries**.

A trust policy says:
> “This role can be assumed by this principal, using this mechanism, under these conditions.”

### **Components:**

#### **Principal**
Defines who can assume the role:
- AWS service principal  
- AWS account  
- IAM user or role in another account  
- Federated identity provider  

#### **Action**
Always:
```
"Action": "sts:AssumeRole"
```

#### **Conditions**
Used to tighten trust:
- `aws:SourceArn`
- `aws:SourceAccount`
- `sts:ExternalId`
- `sts:RoleSessionName`

### **Secure Example — Lambda**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Service": "lambda.amazonaws.com" },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": {
          "aws:SourceAccount": "123456789012"
        },
        "ArnLike": {
          "aws:SourceArn": "arn:aws:lambda:us-east-1:123456789012:function:PaymentsProcessor"
        }
      }
    }
  ]
}
```

This prevents:
- Cross-account abuse  
- Unauthorized Lambda functions from assuming the role  

---

# 4.4 Bad vs Good Trust Policy Examples

### ❌ BAD — Open Principal  
```json
"Principal": "*"
```
Equivalent to no authentication.

### ❌ BAD — Broad AWS Principal  
```json
"Principal": { "AWS": "*" }
```

### ❌ BAD — Missing SourceArn  
This is common in SAM/CloudFormation misconfigurations.

---

### ✅ GOOD — Fully Scoped  
```json
"Principal": { "Service": "lambda.amazonaws.com" },
"Condition": {
  "StringEquals": { "aws:SourceAccount": "123456789012" },
  "ArnLike": { "aws:SourceArn": "arn:aws:lambda:*:123456789012:function:Order*"}
}
```

---

# 4.5 Confused Deputy Protection: ExternalId Explained

When you delegate access to a 3rd-party service, *they* become an AWS principal that can assume your role.

Without ExternalId:
- Another malicious AWS account can impersonate the third party.
- AWS has no way to know which caller is legitimate.

AWS ExternalId docs:  
https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user_externalid.html

---

(End of Sections 3–4)
