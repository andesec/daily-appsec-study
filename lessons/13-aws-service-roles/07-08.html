<section class="card" id="section-7">
    <div class="card-header">7. Practical Implementation &amp; Review (Hands-On)</div>
    <div class="card-body">
        <p>This section mirrors the commands, JSON, and detection artefacts AppSec engineers review in real AWS environments.</p>
    </div>
</section>

<section class="card" id="section-7-1">
    <div class="card-header">7.1 Create a Secure Lambda Execution Role</div>
    <div class="card-body">
        <ol>
            <li>Create the trust policy:
                <pre><code class="language-json">{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": { "Service": "lambda.amazonaws.com" },
    "Action": "sts:AssumeRole",
    "Condition": {
      "StringEquals": { "aws:SourceAccount": "123456789012" },
      "ArnLike": { "aws:SourceArn": "arn:aws:lambda:us-east-1:123456789012:function:DataIngest*" }
    }
  }]
}</code></pre>
            </li>
            <li>Create the role via CLI:
                <pre><code class="language-bash">aws iam create-role \
  --role-name LambdaDataIngestRole \
  --assume-role-policy-document file://trust.json</code></pre>
            </li>
            <li>Attach baseline permissions:
                <pre><code class="language-bash">aws iam attach-role-policy \
  --role-name LambdaDataIngestRole \
  --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole</code></pre>
            </li>
            <li>Add application-specific permissions:
                <pre><code class="language-json">{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Action": "s3:PutObject",
    "Resource": "arn:aws:s3:::incoming-data/*"
  }]
}</code></pre>
            </li>
        </ol>
    </div>
</section>

<section class="card" id="section-7-2">
    <div class="card-header">7.2 Create EC2 Instance Profiles Correctly</div>
    <div class="card-body">
        <ol>
            <li>Create role: <pre><code class="language-bash">aws iam create-role --role-name EC2ProcessorRole --assume-role-policy-document file://ec2-trust.json</code></pre></li>
            <li>Create instance profile: <pre><code class="language-bash">aws iam create-instance-profile --instance-profile-name ProcessorInstanceProfile</code></pre></li>
            <li>Attach role to profile: <pre><code class="language-bash">aws iam add-role-to-instance-profile \
  --instance-profile-name ProcessorInstanceProfile \
  --role-name EC2ProcessorRole</code></pre></li>
            <li>Enforce IMDSv2: <pre><code class="language-bash">aws ec2 modify-instance-metadata-options \
  --instance-id i-12345abcdef \
  --http-tokens required \
  --http-endpoint enabled</code></pre></li>
        </ol>
    </div>
</section>

<section class="card" id="section-7-3">
    <div class="card-header">7.3 Secure vs Insecure Trust Policies</div>
    <div class="card-body">
        <div id="configdiff-aws-secure-trust" class="widget"></div>
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (window.AppSecWidgets && AppSecWidgets.ConfigDiff) {
                AppSecWidgets.ConfigDiff.create(
                    "configdiff-aws-secure-trust",
                    "‚öñÔ∏è Trust Policy Review",
                    `{
  "Principal": "*",
  "Action": "sts:AssumeRole"
}`,
                    `{
  "Principal": { "Service": "ec2.amazonaws.com" },
  "Action": "sts:AssumeRole",
  "Condition": {
    "StringEquals": { "aws:SourceAccount": "123456789012" }
  }
}`
                );
            }
        });
        </script>
        <p>The insecure variant grants universal assumption. The secure version restricts to EC2 in one account.</p>
    </div>
</section>

<section class="card" id="section-7-4">
    <div class="card-header">7.4 Logs &amp; Detection</div>
    <div class="card-body">
        <p>Example GuardDuty finding:</p>
        <pre>
Type: UnauthorizedAccess:EC2/MetadataCredentials
Severity: High
Description: Suspicious retrieval of role credentials from EC2 metadata.
        </pre>
        <p>CloudTrail investigations should look for <code>AssumeRole</code> calls from unusual account IDs or regions.</p>
    </div>
</section>

<section class="card" id="section-7-5">
    <div class="card-header">7.5 Knowledge Check</div>
    <div class="card-body">
        <div id="quiz-aws-roles-hands-on" class="widget"></div>
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                AppSecWidgets.Quiz.create("quiz-aws-roles-hands-on", {
                    title: "üõ†Ô∏è Implementation Quiz",
                    questions: [
                        {
                            text: "Why do we enforce IMDSv2 with --http-tokens required?",
                            options: [
                                { value: "a", label: "To let unauthenticated SSRF calls read metadata", correct: false },
                                { value: "b", label: "To require session tokens before metadata is returned", correct: true },
                                { value: "c", label: "To disable metadata entirely", correct: false },
                                { value: "d", label: "To improve billing metrics", correct: false }
                            ]
                        },
                        {
                            text: "Which CLI command attaches a role to an instance profile?",
                            options: [
                                { value: "a", label: "aws iam attach-role-policy", correct: false },
                                { value: "b", label: "aws iam add-role-to-instance-profile", correct: true },
                                { value: "c", label: "aws iam pass-role", correct: false },
                                { value: "d", label: "aws sts assume-role", correct: false }
                            ]
                        }
                    ]
                });
            }
        });
        </script>
    </div>
</section>

<section class="card" id="section-8">
    <div class="card-header">8. Good Design Principles, Defense &amp; Mitigation</div>
    <div class="card-body">
        <p>Translate best practices into concrete design rules, monitoring controls, and reviewer checklists.</p>
    </div>
</section>

<section class="card" id="section-8-1">
    <div class="card-header">8.1 Design Principles for AWS Roles</div>
    <div class="card-body">
        <ul>
            <li><strong>Principle of least privilege.</strong> Use specific ARNs, limit DynamoDB actions, avoid <code>*</code> resources.</li>
            <li><strong>Defense in depth.</strong> Combine IAM policies, permission boundaries, SCPs, resource policies, KMS key policies, and continuous logging (CloudTrail, GuardDuty).</li>
            <li><strong>Strong trust boundaries.</strong> Bind SourceArn and SourceAccount, restrict principals to services, require ExternalId for vendor/OIDC roles.</li>
            <li><strong>Mandate IMDSv2.</strong> Treat metadata service hardening as table stakes.</li>
            <li><strong>Avoid role reuse.</strong> Every workload (Lambda, EC2, ECS) gets its own role.</li>
        </ul>
    </div>
</section>

<section class="card" id="section-8-2">
    <div class="card-header">8.2 AWS-Specific Controls</div>
    <div class="card-body">
        <ul>
            <li><strong>IAM Access Analyzer</strong> ‚Äì finds unused or public permissions.</li>
            <li><strong>AWS Organizations + SCPs</strong> ‚Äì block risky actions like disabling CloudTrail or creating wildcard roles.</li>
            <li><strong>GuardDuty</strong> ‚Äì detects STS theft, metadata abuse, and privilege escalations.</li>
            <li><strong>CloudWatch alarms</strong> ‚Äì alert on S3 spikes, unusual DynamoDB operations, or AssumeRole surges.</li>
        </ul>
    </div>
</section>

<section class="card" id="section-8-3">
    <div class="card-header">8.3 Reviewer Checklist</div>
    <div class="card-body">
        <div id="checklist-aws-roles" class="widget"></div>
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (window.AppSecWidgets && AppSecWidgets.Checklist) {
                AppSecWidgets.Checklist.create("checklist-aws-roles", {
                    title: "üßæ AWS Role Security Checklist",
                    items: [
                        "Trust policy uses explicit principals",
                        "aws:SourceArn enforced where possible",
                        "Permissions scoped to specific resources",
                        "IMDSv2 required on all EC2 instances",
                        "CloudTrail and GuardDuty enabled across accounts"
                    ]
                });
            }
        });
        </script>
    </div>
</section>

<section class="card" id="section-8-4">
    <div class="card-header">8.4 Pattern Library</div>
    <div class="card-body">
        <div id="patterns-aws-roles" class="widget"></div>
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (window.AppSecWidgets && AppSecWidgets.PatternLibrary) {
                AppSecWidgets.PatternLibrary.create("patterns-aws-roles", {
                    title: "üìö Secure Role Patterns",
                    patterns: [
                        {
                            id: "lambda-role",
                            title: "Scoped Lambda Execution Role",
                            context: "Event-driven ingestion Lambda writing to a single S3 bucket.",
                            rules: [
                                "Principal lambda.amazonaws.com",
                                "aws:SourceArn binds to the function ARN",
                                "Permissions limited to CloudWatch Logs + one S3 prefix"
                            ]
                        },
                        {
                            id: "ec2-role",
                            title: "EC2 Instance Profile with IMDSv2",
                            context: "Processing fleet needs S3 read, DynamoDB write, single secret read.",
                            rules: [
                                "IMDSv2 required with hop limit",
                                "KMS & Secrets Manager scoped to exact ARN",
                                "DynamoDB actions limited to PutItem"
                            ]
                        },
                        {
                            id: "external-vendor",
                            title: "ExternalId Vendor Role",
                            context: "Third-party monitoring service pulls logs via cross-account role.",
                            rules: [
                                "Principal lists vendor AWS account",
                                "Require unique sts:ExternalId per tenant",
                                "Read-only permissions to logging buckets"
                            ]
                        }
                    ]
                });
            }
        });
        </script>
    </div>
</section>

<section class="card" id="section-8-5">
    <div class="card-header">8.5 Knowledge Check</div>
    <div class="card-body">
        <div id="quiz-aws-roles-defense" class="widget"></div>
        <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (window.AppSecWidgets && AppSecWidgets.Quiz) {
                AppSecWidgets.Quiz.create("quiz-aws-roles-defense", {
                    title: "üõ°Ô∏è Defense Quiz",
                    questions: [
                        {
                            text: "Which control surfaces unused or public permissions automatically?",
                            options: [
                                { value: "a", label: "IAM Access Analyzer", correct: true },
                                { value: "b", label: "AWS Shield", correct: false },
                                { value: "c", label: "Amazon Macie", correct: false },
                                { value: "d", label: "Trusted Advisor", correct: false }
                            ]
                        },
                        {
                            text: "What is the recommended response when reviewers find role reuse across services?",
                            options: [
                                { value: "a", label: "Allow reuse to reduce IAM objects", correct: false },
                                { value: "b", label: "Break out dedicated roles per workload", correct: true },
                                { value: "c", label: "Switch to IAM users", correct: false },
                                { value: "d", label: "Disable CloudTrail", correct: false }
                            ]
                        }
                    ]
                });
            }
        });
        </script>
    </div>
</section>
