
# Lesson 13: AWS Service Roles  
## Sections 7–8 (Maximum Detail + Widget Suggestions)

---

# 7. Practical Implementation and Review (Hands-On)

This section provides **real AWS CLI commands**, **secure vs insecure IAM JSON**, **configuration diffs**, **log examples**, and **attack detection signals**.  
It simulates what an **AppSec engineer, cloud defender, or pentester** would do when analyzing AWS service roles.

---

# 7.1 Creating a Secure Lambda Execution Role

### **1. Create Trust Policy**
```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": { "Service": "lambda.amazonaws.com" },
    "Action": "sts:AssumeRole",
    "Condition": {
      "StringEquals": { "aws:SourceAccount": "123456789012" },
      "ArnLike": { "aws:SourceArn": "arn:aws:lambda:us-east-1:123456789012:function:DataIngest*" }
    }
  }]
}
```

### **2. Create Role via CLI**
```bash
aws iam create-role   --role-name LambdaDataIngestRole   --assume-role-policy-document file://trust.json
```

### **3. Attach Permissions**
```bash
aws iam attach-role-policy   --role-name LambdaDataIngestRole   --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
```

### **4. Add Application-Specific Policy**
```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Action": "s3:PutObject",
    "Resource": "arn:aws:s3:::incoming-data/*"
  }]
}
```

---

# 7.2 Creating EC2 Instance Profiles (Correctly)

### **1. Create Role**
```bash
aws iam create-role   --role-name EC2ProcessorRole   --assume-role-policy-document file://ec2-trust.json
```

### **2. Create Instance Profile**
```bash
aws iam create-instance-profile   --instance-profile-name ProcessorInstanceProfile
```

### **3. Attach Role to Profile**
```bash
aws iam add-role-to-instance-profile   --instance-profile-name ProcessorInstanceProfile   --role-name EC2ProcessorRole
```

### **4. Enforce IMDSv2**
```bash
aws ec2 modify-instance-metadata-options   --instance-id i-12345abcdef   --http-tokens required   --http-endpoint enabled
```

---

# 7.3 Secure vs Insecure Trust Policy (Code Review Example)

### ❌ Insecure
```json
{
  "Principal": "*",
  "Action": "sts:AssumeRole"
}
```

Issues:
- Allows ANY AWS principal to assume the role.
- Equivalent to zero authentication.
- High-risk identity takeover vector.

---

### ✅ Secure Version
```json
{
  "Principal": { "Service": "ec2.amazonaws.com" },
  "Action": "sts:AssumeRole",
  "Condition": {
    "StringEquals": {
      "aws:SourceAccount": "123456789012"
    }
  }
}
```

---

# 7.4 Logs to Detect Abuse (Real Examples)

### GuardDuty Finding: Instance Metadata Exfiltration
```
Type: UnauthorizedAccess:EC2/MetadataCredentials
Severity: High
Description: Suspicious retrieval of role credentials from EC2 metadata.
```

### CloudTrail Example: Abnormal AssumeRole
```
{
  "eventSource": "sts.amazonaws.com",
  "eventName": "AssumeRole",
  "userIdentity": {
    "type": "AWSAccount",
    "accountId": "attacker-account-id"
  },
  "requestParameters": {
    "roleArn": "arn:aws:iam::123456789012:role/MySensitiveRole"
  }
}
```

---

# 7.5 Widget Suggestions (Codex Instructions)

### **ConfigDiff**
Show secure vs insecure EC2 instance trust policies.

**Data:**
```json
{
  "title": "Secure vs Insecure EC2 Trust Policy",
  "insecureCode": "{ "Principal": "*", "Action": "sts:AssumeRole" }",
  "secureCode": "{ "Principal": {"Service": "ec2.amazonaws.com"}, "Action": "sts:AssumeRole", "Condition": {"StringEquals": {"aws:SourceAccount": "123456789012"}}}"
}
```

---

### **CodeReviewChecker**
Scan IAM role JSON for:

- Missing `Condition`
- Overly broad principals
- S3 `*` resources
- KMS `kms:*` permissions
- Admin policies attached to Lambda roles

---

### **LogAnalyzer**
Load the above GuardDuty + CloudTrail samples as threat indicators.

---

### **HTTPSimulator**
Simulate internal metadata calls.

---

---

# 8. Good Design Principles, Defense & Mitigation

This section summarizes actionable, high-value security guidance for AppSec engineers reviewing AWS identities.

---

# 8.1 Design Principles for All AWS Roles

### **1. Principle of Least Privilege**
Grant only the minimum actions:
- Use specific S3 ARNs  
- Limit DynamoDB actions (PutItem only)  
- Avoid `*` in `Resource`  

### **2. Defense-in-Depth Across Identity Layers**
- IAM permission boundaries  
- Service Control Policies (SCPs)  
- Resource-based policies  
- KMS key policies  
- CloudTrail + GuardDuty  

### **3. Strong Trust Boundaries**
Trust must always:
- Bind SourceArn  
- Bind SourceAccount  
- Restrict principal to AWS services  
- Use ExternalId for OIDC / vendor roles  

### **4. Enforce IMDSv2 Across All EC2 Instances**
This is critical to avoid SSRF-based metadata attacks.

### **5. Avoid Cross-Service Role Reuse**
Each workload gets its own role:
- LambdaRole-DataIngest  
- EC2Role-DataProcessor  
- ECSRole-WorkerCluster  

Never share roles.

---

# 8.2 AWS-Specific Controls (Real-World)

### **IAM Access Analyzer**
Detects:
- Unused permissions  
- Public or cross-account trust  
- Overly broad resource access  

### **AWS Organizations + SCPs**
Restricts:
- Creating IAM roles  
- Disabling CloudTrail  
- Using administrative actions  

### **GuardDuty**
Detects:
- STS credential theft  
- Metadata exfiltration  
- Role escalation attempts  

### **CloudWatch Alarms**
Monitor:
- High-volume S3 operations  
- Abnormal DynamoDB reads  
- AssumeRole spikes  

---

# 8.3 Reviewer Checklist (AppSec and Cloud Security)

### Identity & Permissions
- [ ] Is the trust policy restricted to correct principal?  
- [ ] Is `aws:SourceArn` present?  
- [ ] Are permissions resource-scoped?  
- [ ] Is IMDSv2 enforced?  
- [ ] Are policies checked using IAM Access Analyzer?  

### Logging
- [ ] Is CloudTrail enabled in all accounts?  
- [ ] Are GuardDuty findings monitored?  

### Cross-Account Rules
- [ ] Are ExternalIds used?  
- [ ] Are SCPs preventing privilege escalation?  

---

# 8.4 Widget Suggestions (Codex Instructions)

### **Checklist Widget**
Represent the Reviewer Checklist as a `Checklist` widget.

**Example:**
```json
{
  "title": "AWS Role Security Checklist",
  "items": [
    "Trust policy uses specific principals",
    "aws:SourceArn is enforced",
    "Least privilege permissions applied",
    "IMDSv2 required",
    "CloudTrail + GuardDuty enabled"
  ]
}
```

### **PatternLibrary**
Document common secure patterns:
- Lambda role pattern  
- EC2 instance role pattern  
- ExternalId cross-account role pattern  

---

(End of Sections 7–8)
