
# Lesson 13: AWS Service Roles  
## Sections 5–6 (Maximum Detail + Widget Suggestions)

---

# 5. Real-World Context & Interactions

In modern SaaS, microservice, and event-driven architectures, AWS service roles (Lambda roles, EC2 instance profiles, and trust policies) are central to secure workload identity. This section grounds the theory in a **realistic enterprise scenario** and shows how identity flows between components.

---

## 5.1 Scenario: Event-Driven Data Processing Pipeline

Imagine a multi-account environment:

- **Account A (Edge / Public Facing)**: API Gateway + Lambda ingestion.
- **Account B (Core Processing)**: EC2 processing farm reading S3 events.
- **Account C (Security)**: Central logging, SIEM, IAM Access Analyzer.

### High-Level Flow

```
   [API Gateway]
         |
         v
   [Ingestion Lambda] --(stores files)--> [S3 Bucket]
         |
         v
   [SNS Topic] ------------------------------+
                                             |
                                             v
                                  [EC2 Processing Cluster]
                                             |
                                             +--> [DynamoDB]
                                             |
                                             +--> [Central Logging / SIEM]
```

### Roles Involved

| Component | Role | Purpose |
|----------|------|----------|
| Lambda Ingestor | LambdaExecutionRole | Write logs, put S3 objects, publish SNS messages |
| EC2 Processor | EC2InstanceRole | Read S3, write DynamoDB, read secrets |
| Security Services | SecurityRole | Log ingestion, Access Analyzer, GuardDuty |

---

## 5.2 Identity and Trust Boundaries

### Lambda:  
- Trust policy principal: `lambda.amazonaws.com`
- Permissions: S3 upload only

### EC2:  
- Trust policy principal: `ec2.amazonaws.com`
- Permissions:  
  - Specific bucket reads  
  - DynamoDB table writes  
  - Secrets Manager read for **a single secret**

### S3 Bucket Policy (Resource-based)
```json
{
  "Effect": "Allow",
  "Principal": {"AWS": "arn:aws:iam::B:role/EC2ProcessorRole"},
  "Action": "s3:GetObject",
  "Resource": "arn:aws:s3:::inbound-data/*"
}
```

---

## 5.3 Interaction Diagram (ASCII)

```
[Lambda] --AssumeRole--> [STS] --TempCreds--> [Lambda Runtime]
     |                                         |
     +------> S3:PutObject ---------------------+

[EC2 Node] --IMDSv2--> [Role Creds] --> [SDK Calls]
     |                                    |
     +---> S3:GetObject ------------------+
     +---> DynamoDB:PutItem --------------+
```

---

## 5.4 Widget Suggestions (Codex Instructions)

### **FlowVisualizer**  
Show the full identity flow:

- Lambda → STS → Execution Role → S3  
- EC2 → IMDSv2 → Role → S3/DynamoDB  

**Widget Data Template:**
```json
{
  "steps": [
    {"title": "Lambda Triggered", "description": "Lambda invocation begins through API Gateway or S3."},
    {"title": "AssumeRole", "description": "Lambda service calls STS to assume the LambdaExecutionRole."},
    {"title": "Temporary Credentials", "description": "STS issues temporary credentials to Lambda."},
    {"title": "EC2 Startup", "description": "EC2 boots with an Instance Profile mapping to its role."},
    {"title": "IMDSv2", "description": "Application retrieves temporary credentials from metadata service."}
  ]
}
```

### **ConfigDiff**  
Compare insecure vs. secure trust policies.

### **CodeReviewChecker**  
Analyze Lambda/EC2 IAM JSON debug findings.

### **APITester**  
Simulate mis-scoped permissions (optional).

---

---

# 6. Common Weaknesses, Pitfalls & Attack Paths

This section provides real-world exploit patterns, failure modes, detection methods, and mitigations. These map closely to MITRE ATT&CK cloud techniques.

---

# 6.1 Weakness 1 — Over-Permissive Lambda Execution Roles

### Insecure Example
```json
{
  "Effect": "Allow",
  "Action": "s3:*",
  "Resource": "*"
}
```

### Impact
- Lambda RCE → full S3 account compromise
- Attack path:
  - Upload shell into Lambda package
  - Trigger RCE through template injection or command execution
  - Use Lambda credentials to enumerate S3, DynamoDB, SecretsManager

### Detection
- IAM Access Analyzer alerts  
- GuardDuty: `IAMUser/AnomalousBehavior`  
- CloudTrail: Unexpected high-volume S3 API calls  

### Mitigation
- Enforce least privilege
- Use resource-level scoping:
```json
"Resource": "arn:aws:s3:::inbound-data/*"
```

---

# 6.2 Weakness 2 — Broad Trust Policies (Identity Takeover)

### Insecure Trust Policy
```json
"Principal": "*"
```

### Attack Path
1. Any AWS account assumes the role.
2. Attacker now possesses trusted internal identity.
3. Attack escalates to internal systems.

### Detection
- CloudTrail: AssumeRole from unknown account  
- GuardDuty: `UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration`  

### Mitigation
- Restrict principals to AWS services or explicit roles.
- Bind roles using:
  - `aws:SourceAccount`
  - `aws:SourceArn`

---

# 6.3 Weakness 3 — IMDSv1 Exposure → Metadata Theft (Capital One Pattern)

If EC2 still supports IMDSv1:

### Exploit Workflow (SSRF)
```
Attacker → SSRF → http://169.254.169.254/latest/meta-data/iam/
                           |
                           +--> temporary STS credentials
```

### Impact
- Compromise of EC2 instance identity
- S3 data exfiltration
- Lateral movement

### Prevention
- Enforce IMDSv2:
```
aws ec2 modify-instance-metadata-options --instance-id i-123456 --http-endpoint enabled --http-tokens required
```

---

# 6.4 Weakness 4 — Missing ExternalId (Confused Deputy)

Used in cross-account vendor setups.

### Example Insecure Trust
```json
"Principal": {"AWS": "123456789000"}
```

### Impact
Another AWS account could impersonate the vendor.

### Secure Version
```json
"Condition": {
  "StringEquals": {
    "sts:ExternalId": "unique-customer-token"
  }
}
```

---

# 6.5 Weakness 5 — Excessive KMS Privileges

### Insecure
```json
"kms:*"
```

### Impact
- Data tampering
- Key deletion
- Decryption of sensitive data

---

# 6.6 Widget Suggestions (Codex Instructions)

### **AttackSandbox**
Simulate the Capital One SSRF-to-Metadata exploitation:

**Widget Data Template:**
```json
{
  "scenarios": [
    {
      "name": "SSRF Metadata Theft",
      "description": "Simulate an attacker using SSRF to read EC2 role credentials.",
      "payload": "GET /latest/meta-data/iam/security-credentials/",
      "response": "Temporary STS credentials leakage example",
      "notifyType": "danger",
      "notifyMessage": "Metadata credentials exposed!"
    }
  ]
}
```

### **LogAnalyzer**
Show GuardDuty findings from metadata exfiltration.

### **ConfigDiff**
Compare IMDSv1 vs IMDSv2 configurations.

---

(End of Sections 5–6)
