<!-- ====================================== -->
<!-- Section 9: Incident Case Study and Analysis -->
<!-- ====================================== -->
<section class="card">
  <div class="card-header">9. Incident Case Study and Analysis ğŸ“‰</div>
  <div class="card-body">
    <p>
      For TOCTOU race conditions, many real incidents are quietly fixed rather than publicly branded as â€œrace condition bugsâ€.
      However, patterns have been documented extensively by security researchers (e.g., PortSwiggerâ€™s race condition research,
      CWE-367 â€“ Time-of-check Time-of-use). We will model a realistic composite incident based on documented
      double-spend and over-booking issues in payment and ticketing systems.
    </p>

    <div class="callout callout-info-solid">
      Think of this as a <strong>representative real-world incident</strong> that could (and has) happened in many services:
      a wallet-backed purchase flow where concurrent requests bypass business invariants.
    </div>

    <p><strong>Scenario:</strong> A large SaaS platform provides a wallet feature. Users can top up balance and make purchases.
      An attacker discovers that firing concurrent purchase requests allows them to obtain more value than their wallet holds.</p>

    <p><strong>High-level architecture:</strong></p>
    <pre>
Client (attacker) 
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Gateway  â”‚ â”€â”€â”€â–º  â”‚ Billing Serviceâ”‚ â”€â”€â”€â–º  â”‚ PostgreSQL DB  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                        Redis Cache (balances)
    </pre>
  </div>
</section>

<!-- ======================= -->
<!-- Section 9.1: Failure Point & Exploit Path -->
<!-- ======================= -->
<section class="card">
  <div class="card-header">9.1 Failure Point & Exploit Path</div>
  <div class="card-body">
    <p>
      The vulnerable implementation in the Billing Service performs a non-atomic check-then-update on the wallet balance,
      sometimes using a cached balance value:
    </p>

    <pre>
1. GET /wallet/balance  â†’ returns 100
2. GET /purchase/item   â†’ checks balance >= 100 (uses cached or DB value)
3. If OK, later writes new balance = balance - 100
    </pre>

    <p><strong>Exploit strategy:</strong></p>
    <ul>
      <li>Attacker tops up their wallet to $100.</li>
      <li>They script 10â€“20 parallel purchase requests for a $100 item (HTTP/2, Burp Intruder, custom tool).</li>
      <li>All requests read the same initial balance (100) before any write commits.</li>
      <li>Several purchases succeed before the database balance is reduced, producing a negative or inconsistent balance.</li>
    </ul>

    <div id="section9-timeline"></div>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
      AppSecWidgets.VulnerabilityTimeline.create("section9-timeline", {
        title: "ğŸ“… Incident Timeline â€“ Wallet Race Condition",
        vulnerabilities: [
          {
            id: "RACE-2025-001",
            date: "2025-03-10",
            title: "Bug introduced",
            description: "Refactor moved debit logic out of transaction, introducing TOCTOU race.",
            severity: "Medium"
          },
          {
            id: "RACE-2025-002",
            date: "2025-06-01",
            title: "First anomalous negative balances",
            description: "Monitoring flagged sporadic negative balances under peak load.",
            severity: "High"
          },
          {
            id: "RACE-2025-003",
            date: "2025-07-15",
            title: "Abuse by attacker",
            description: "Attacker amplifies race, obtaining thousands of dollars of goods with $100 deposit.",
            severity: "Critical"
          },
          {
            id: "RACE-2025-004",
            date: "2025-08-01",
            title: "Fix deployed",
            description: "Introduced DB transaction with row-level locking and removed cache-based balance checks.",
            severity: "High"
          }
        ],
        placeholder: "Timeline of how a small race bug evolved into a high-severity incident."
      });
    });
    </script>

    <div class="callout callout-danger">
      Root Cause: The system used a <strong>non-atomic check-then-debit</strong> pattern on a shared wallet balance, sometimes
      via a stale cache read, with no transactional isolation or locking.
    </div>
  </div>
</section>

<!-- ======================= -->
<!-- Section 9.2: Detection & Fix -->
<!-- ======================= -->
<section class="card">
  <div class="card-header">9.2 Detection & Fix</div>
  <div class="card-body">
    <p><strong>Detection signals</strong> observed in production:</p>
    <ul>
      <li>Accounts with negative balances despite no overdraft feature.</li>
      <li>Multiple purchases for the same user with identical <code>balance_before</code> values in logs.</li>
      <li>Spike in concurrent requests to <code>/purchase</code> from the same IP/user within milliseconds.</li>
    </ul>

    <div id="section9-logs"></div>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
      AppSecWidgets.LogAnalyzer.create("section9-logs", {
        title: "ğŸ” Security Log Analyzer â€“ Incident Signals",
        columns: ["Time", "Event", "User", "Amount", "BalanceBefore", "BalanceAfter", "Status"],
        logs: [
          {
            time: "12:00:00.101",
            event: "purchase_item",
            user: "attacker-01",
            amount: "100",
            BalanceBefore: "100",
            BalanceAfter: "0",
            status: "success",
            severity: "info"
          },
          {
            time: "12:00:00.103",
            event: "purchase_item",
            user: "attacker-01",
            amount: "100",
            BalanceBefore: "100",
            BalanceAfter: "-100",
            status: "success",
            severity: "danger"
          },
          {
            time: "12:00:00.104",
            event: "fraud_alert",
            user: "attacker-01",
            amount: "0",
            BalanceBefore: "-100",
            BalanceAfter: "-100",
            status: "blocked",
            severity: "warning"
          }
        ],
        placeholder: "Look for multiple successes with identical BalanceBefore, and negative balances."
      });
    });
    </script>

    <p><strong>Fix (high level):</strong></p>
    <ul>
      <li>Move debit logic into a single DB transaction using <code>SELECT ... FOR UPDATE</code> on the wallet row.</li>
      <li>Remove cache-based balance checks for final authorization; use cache only for display.</li>
      <li>Introduce idempotency keys for purchase requests to prevent replay/double-charge.</li>
      <li>Add monitoring rules for negative balances and duplicate debits.</li>
    </ul>

    <div class="callout callout-info-solid">
      The incident demonstrates how a â€œsimple refactorâ€ that separated checks and updates across layers
      transformed a correct design into a race-prone one.
    </div>

    <p><strong>Further reading:</strong></p>
    <ul>
      <li>OWASP Race Conditions: https://owasp.org/www-community/attacks/Time_of_check_time_of_use</li>
      <li>CWE-367: Time-of-check Time-of-use Race Condition: https://cwe.mitre.org/data/definitions/367.html</li>
      <li>PortSwigger Web Security Academy â€“ Race conditions: https://portswigger.net/web-security/race-conditions</li>
    </ul>
  </div>
</section>

<!-- ======================= -->
<!-- Section 9.3: Knowledge Check -->
<!-- ======================= -->
<section class="card">
  <div class="card-header">9.3 Knowledge Check</div>
  <div class="card-body">
    <div id="section9-quiz"></div>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
      AppSecWidgets.Quiz.create("section9-quiz", {
        title: "ğŸ—˜ï¸ Section 9 Quiz",
        mode: "step",
        questions: [
          {
            text: "What was the core root cause of the incident?",
            options: [
              { value: "1", label: "Non-atomic check-then-debit on wallet balance", correct: true },
              { value: "2", label: "Lack of TLS on API endpoints", correct: false },
              { value: "3", label: "Incorrect tax calculation", correct: false }
            ]
          },
          {
            text: "Which signal strongly suggests a TOCTOU exploit?",
            options: [
              { value: "1", label: "Negative balances and duplicate debits with identical BalanceBefore", correct: true },
              { value: "2", label: "Single failed login attempt", correct: false }
            ]
          }
        ]
      });
    });
    </script>
  </div>
</section>

<!-- ====================================== -->
<!-- Section 10: Threat Model and Analysis ğŸ¯ -->
<!-- ====================================== -->
<section class="card">
  <div class="card-header">10. Threat Model and Analysis ğŸ¯</div>
  <div class="card-body">
    <p>
      We will build a STRIDE-style threat model for the wallet/payment architecture with a focus on TOCTOU race conditions.
      The aim is to identify who can race what, where, and with what business impact.
    </p>

    <div class="callout callout-info-solid">
      For TOCTOU, pay special attention to <strong>Tampering</strong>, <strong>Denial of Service</strong>, and
      <strong>Elevation of Privilege</strong> via stale authorization checks.
    </div>

    <p><strong>ASCII data flow diagram (DFD):</strong></p>
    <pre>
      +-----------+        +-------------+        +----------------+
      |  Attacker | -----> | API Gateway | -----> | Billing Service|
      +-----------+        +-------------+        +----------------+
                                                          |
                                                          v
                                                  +---------------+
                                                  |  DB (wallets) |
                                                  +---------------+
                                                          ^
                                                          |
                                                   +-------------+
                                                   | Redis Cache |
                                                   +-------------+
    </pre>
  </div>
</section>

<!-- ======================= -->
<!-- Section 10.1: STRIDE Threats -->
<!-- ======================= -->
<section class="card">
  <div class="card-header">10.1 STRIDE Threats Focused on TOCTOU</div>
  <div class="card-body">
    <p><strong>STRIDE analysis (TOCTOU-focused):</strong></p>
    <ul>
      <li><strong>S â€“ Spoofing:</strong> Stolen tokens could let attacker race as a privileged user, but this is orthogonal to TOCTOU itself.</li>
      <li><strong>T â€“ Tampering:</strong> Concurrent updates tamper with wallet and inventory records by exploiting non-atomic logic.</li>
      <li><strong>R â€“ Repudiation:</strong> Lack of detailed logs (balance_before / after, correlation IDs) allows users to deny having exploited the race.</li>
      <li><strong>I â€“ Information Disclosure:</strong> Timing behavior could leak information about internal locking, but impact is secondary.</li>
      <li><strong>D â€“ Denial of Service:</strong> Aggressive race attempts could lock rows or saturate DB, causing system slowdown.</li>
      <li><strong>E â€“ Elevation of Privilege:</strong> Stale authorization checks may allow actions after privilege revocation.</li>
    </ul>

    <div id="section10-threatmodel"></div>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
      AppSecWidgets.ThreatModel.create("section10-threatmodel", {
        system: {
          name: "Wallet Billing System",
          type: "Multi-tenant SaaS",
          actors: "End users, attackers, internal services",
          assets: "Wallet balances, inventory, audit logs",
          entryPoints: "HTTPS APIs via API Gateway",
          boundaries: "Internet â†” Gateway â†” Billing Service â†” DB/Cache"
        },
        stride: {
          spoofing: "Use stolen auth tokens to initiate races as legitimate users.",
          tampering: "Exploit TOCTOU to force inconsistent writes to wallet balances.",
          repudiation: "Exploit weak logging to deny race abuse; logs lack correlation IDs.",
          information: "Use timing to infer lock contention or balance states.",
          dos: "Flood concurrent requests to lock rows or exhaust DB connections.",
          elevation: "Execute privileged operations after role revocation due to stale checks."
        }
      }, {
        title: "ğŸ¯ TOCTOU Threat Modeling Canvas"
      });
    });
    </script>
  </div>
</section>

<!-- ======================= -->
<!-- Section 10.2: Knowledge Check -->
<!-- ======================= -->
<section class="card">
  <div class="card-header">10.2 Knowledge Check</div>
  <div class="card-body">
    <div id="section10-quiz"></div>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
      AppSecWidgets.Quiz.create("section10-quiz", {
        title: "ğŸ—˜ï¸ Section 10 Quiz",
        mode: "step",
        questions: [
          {
            text: "Which STRIDE category most directly captures TOCTOU double-spend issues?",
            options: [
              { value: "1", label: "Tampering", correct: true },
              { value: "2", label: "Information Disclosure", correct: false }
            ]
          },
          {
            text: "What aspect of logging reduces repudiation risk in race attacks?",
            options: [
              { value: "1", label: "Capturing balance_before and balance_after with correlation IDs", correct: true },
              { value: "2", label: "Logging only HTTP status codes", correct: false }
            ]
          }
        ]
      });
    });
    </script>
  </div>
</section>

<!-- ====================================== -->
<!-- Section 11: Compliance Mapping ğŸ“‹ -->
<!-- ====================================== -->
<section class="card">
  <div class="card-header">11. Compliance Mapping ğŸ“‹</div>
  <div class="card-body">
    <p>
      TOCTOU race conditions are not usually named explicitly in compliance frameworks, but the underlying controls
      around <strong>integrity, access control, and logging</strong> map directly to requirements in ISO 27001, NIST 800-53,
      PCI DSS, SOC 2, and (indirectly) GDPR/HIPAA when financial or personal data is involved.
    </p>

    <div class="callout callout-info-solid">
      Think of TOCTOU mitigations as part of your <strong>application integrity</strong> and <strong>change control</strong>
      story. If concurrent operations can break business invariants, you are at risk of violating multiple framework controls.
    </div>

    <p><strong>Framework alignment (high level):</strong></p>
    <ul>
      <li><strong>ISO 27001:</strong> A.14 (System acquisition, development and maintenance), A.12 (Operations security).</li>
      <li><strong>NIST 800-53:</strong> SA-11 (Developer Security Testing), SI-7 (Software, Firmware, and Information Integrity), AU-3/6 (Logging).</li>
      <li><strong>PCI DSS:</strong> Requirements 6 (Secure systems/applications), 10 (Logging and monitoring) for payment flows.</li>
      <li><strong>SOC 2 (Security, Availability, Processing Integrity):</strong> Controls around change management, logical access, and processing integrity.</li>
      <li><strong>GDPR / HIPAA:</strong> When TOCTOU corrupts or exposes personal/health data, integrity and security obligations apply but are indirect.</li>
    </ul>
  </div>
</section>

<!-- ======================= -->
<!-- Section 11.1: Control Mapping Checklist -->
<!-- ======================= -->
<section class="card">
  <div class="card-header">11.1 Control Mapping Checklist</div>
  <div class="card-body">
    <p>
      Use this checklist to connect your TOCTOU defenses to specific controls during audits and design reviews.
    </p>

    <div id="section11-checklist"></div>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
      AppSecWidgets.Checklist.create("section11-checklist", {
        title: "âœ… TOCTOU Compliance Checklist",
        items: [
          "ISO 27001 A.14: Are secure development practices including race-condition testing and code review in place?",
          "NIST 800-53 SA-11: Are concurrency and race conditions covered in security testing and static analysis?",
          "NIST 800-53 SI-7: Do you enforce data integrity via atomic DB operations and constraints?",
          "PCI DSS Req 6: Are payment-related balance/inventory updates protected with transactions and locking?",
          "PCI DSS Req 10: Do logs include enough detail (user, balance_before, balance_after) to investigate anomalies?",
          "SOC 2 Processing Integrity: Are business invariants (no negative balance, no double shipping) enforced even under concurrent load?"
        ]
      });
    });
    </script>
  </div>
</section>

<!-- ======================= -->
<!-- Section 11.2: Knowledge Check -->
<!-- ======================= -->
<section class="card">
  <div class="card-header">11.2 Knowledge Check</div>
  <div class="card-body">
    <div id="section11-quiz"></div>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
      AppSecWidgets.Quiz.create("section11-quiz", {
        title: "ğŸ—˜ï¸ Section 11 Quiz",
        mode: "step",
        questions: [
          {
            text: "Which PCI DSS requirement is most directly impacted by TOCTOU in payment balances?",
            options: [
              { value: "1", label: "Requirement 6 â€“ Develop and maintain secure systems and applications", correct: true },
              { value: "2", label: "Requirement 3 â€“ Protect stored cardholder data only", correct: false }
            ]
          },
          {
            text: "Which NIST 800-53 control most clearly relates to enforcing data integrity against race conditions?",
            options: [
              { value: "1", label: "SI-7 â€“ Software, Firmware, and Information Integrity", correct: true },
              { value: "2", label: "PE-3 â€“ Physical Access Control", correct: false }
            ]
          }
        ]
      });
    });
    </script>
  </div>
</section>