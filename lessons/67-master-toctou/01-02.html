<!-- ========================= -->
<!-- Section 1: Foundations    -->
<!-- ========================= -->
<div class="card-body">
    <p>
        TOCTOU (‚ÄúTime-of-Check to Time-of-Use‚Äù) race conditions occur when an application checks a condition and then,
        before the result is used, the underlying state changes. This makes the check invalid and opens the door to
        double-spend, privilege escalation, over-withdrawal, and data corruption. These failures are common in
        multi-threaded, asynchronous, and microservice architectures.
    </p>

    <div class="callout callout-info-solid">
        TOCTOU is fundamentally a **consistency problem** disguised as a **security flaw**.  
        It emerges anywhere a check and the action based on that check are not **atomic**.
    </div>

    <p>Core prerequisites:</p>
    <ul>
        <li>Basic understanding of concurrency (threads, async jobs, transactions)</li>
        <li>Understanding of shared state (DB rows, caches, files, queues)</li>
        <li>Familiarity with atomicity and isolation levels in databases</li>
    </ul>

    <p>ASCII overview:</p>
    <pre>
User Request  ‚îÄ‚îÄ‚ñ∫  Check balance (A=100)
                     ‚îÇ
                     ‚îÇ   <‚îÄ‚îÄ another request reduces A to 0
                     ‚ñº
                  Use balance (still assuming 100) ‚îÄ‚îÄ‚îÄ‚ñ∫ Vulnerable outcome
    </pre>
</div>

<!-- ========================= -->
<!-- Section 1.1: Core Concepts -->
<!-- ========================= -->
<section class="card">
    <div class="card-header">1.1 Core Concepts</div>
    <div class="card-body">
        <p>
            TOCTOU arises because state can mutate between operations. In distributed systems, the ‚Äúgap‚Äù is not merely
            milliseconds ‚Äî it may be seconds due to network latency, retries, caching, or queue delays.
        </p>

        <div class="callout callout-warning">
            **The danger:** Attackers exploit this gap by sending concurrent requests strategically to desynchronize the
            system‚Äôs expectations from reality.
        </div>

        <table>
            <tr><th>Term</th><th>Meaning</th></tr>
            <tr><td>Time-of-Check</td><td>The moment the system validates a condition</td></tr>
            <tr><td>Time-of-Use</td><td>The moment the system uses the result of the check</td></tr>
            <tr><td>Critical Section</td><td>Region where state must not change</td></tr>
            <tr><td>Atomicity</td><td>Check and use occur as one indivisible action</td></tr>
        </table>

        <p>Authoritative sources:</p>
        <ul>
            <li>OWASP Race Conditions: https://owasp.org/www-community/attacks/Time_of_check_time_of_use</li>
            <li>CERT Oracle Coding Standard, Concurrency: https://wiki.sei.cmu.edu/confluence</li>
        </ul>
    </div>
</section>

<!-- ========================= -->
<!-- Section 1.2: Where TOCTOU Happens -->
<!-- ========================= -->
<section class="card">
    <div class="card-header">1.2 Where TOCTOU Happens</div>
    <div class="card-body">
        <p>Common scenarios where TOCTOU is typically found:</p>

        <ul>
            <li>Balance checks before withdrawal (double-spend)</li>
            <li>Inventory validation before reservation confirmation</li>
            <li>Permission checks before updating shared records</li>
            <li>Filesystem checks for symlinks or temporary files</li>
            <li>Cache vs database inconsistency during high load</li>
        </ul>

        <div class="callout callout-danger">
            **Looks safe but isn‚Äôt:**  
            <code>if (balance >= price) { charge(); }</code>  
            This is a classic TOCTOU vulnerability without transaction locking.
        </div>
    </div>
</section>

<!-- ========================= -->
<!-- Section 1.3: Why It Matters -->
<!-- ========================= -->
<section class="card">
    <div class="card-header">1.3 Why It Matters</div>
    <div class="card-body">
        <p>
            Race conditions are difficult to detect through manual testing. Attackers rely on concurrency, automation,
            and latency manipulation to force inconsistent states.
        </p>

        <p>Why it‚Äôs severe:</p>
        <ul>
            <li>Enables financial fraud (double spending, over-withdrawal)</li>
            <li>Enables privilege escalation (permissions changing mid-flight)</li>
            <li>Corrupts shared records in multi-tenant SaaS platforms</li>
            <li>Breaks invariants guaranteed by business logic</li>
        </ul>

        <p>ASCII illustration of attackers racing requests:</p>
        <pre>
Request A ‚îÄ‚îÄ‚ñ∫ Check OK ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                           ‚îÇ  Gap
Request B ‚îÄ‚îÄ‚ñ∫ Mutate state ‚îò
                           ‚ñº
Use result (still OK) ‚îÄ‚îÄ‚îÄ‚ñ∫ Compromised operation
        </pre>

        <div id="section-1-quiz"></div>
        <script>
        AppSecWidgets.Quiz.create("section-1-quiz", {
            title: "üóòÔ∏è Knowledge Check ‚Äì Section 1",
            mode: "step",
            questions: [
                {
                    text: "What makes TOCTOU possible?",
                    options: [
                        { value: "1", label: "A gap between check and use", correct: true },
                        { value: "2", label: "Slow networks only", correct: false },
                        { value: "3", label: "Outdated libraries", correct: false }
                    ]
                },
                {
                    text: "Which is a common real-world TOCTOU scenario?",
                    options: [
                        { value: "1", label: "Checking balance before withdrawal", correct: true },
                        { value: "2", label: "Rendering UI components", correct: false }
                    ]
                }
            ]
        });
        </script>
    </div>
</section>

<!-- ========================= -->
<!-- Section 2: Intuitive Hook -->
<!-- ========================= -->
<section class="card">
    <div class="card-header">2. Intuitive Hook</div>
    <div class="card-body">
        <p>
            Imagine a **coffee shop loyalty card**: you check that you have 1 free drink stamp left, and while you walk
            toward the counter, someone else uses the same physical card to redeem it. You present your card confidently,
            unaware the state has changed.  
            That gap equals TOCTOU.
        </p>

        <div class="callout callout-info-solid">
            TOCTOU is like believing a fact about the world that becomes false before you act ‚Äî but your system continues
            believing the old truth.
        </div>
    </div>
</section>

<!-- ========================= -->
<!-- Section 2.1: Analogy Breakdown -->
<!-- ========================= -->
<section class="card">
    <div class="card-header">2.1 Analogy Breakdown</div>
    <div class="card-body">
        <p>Using the loyalty card analogy:</p>

        <table>
            <tr><th>Analogy Element</th><th>System Equivalent</th></tr>
            <tr><td>Checking stamp count</td><td>Business rule check (balance, quota, permissions)</td></tr>
            <tr><td>Walking to counter</td><td>Latency / concurrency window</td></tr>
            <tr><td>Someone else redeeming</td><td>Concurrent state mutation</td></tr>
            <tr><td>Presenting your card</td><td>Acting on stale, invalidated assumptions</td></tr>
        </table>

        <pre>
Check: "1 stamp left"
Gap:  Someone else redeems it
Use:  "Redeem stamp" ‚Üí inconsistent ‚Üí vulnerability
        </pre>

        <div id="section-2-quiz"></div>
        <script>
        AppSecWidgets.Quiz.create("section-2-quiz", {
            title: "üóòÔ∏è Knowledge Check ‚Äì Section 2",
            mode: "step",
            questions: [
                {
                    text: "In the analogy, what represents the TOCTOU gap?",
                    options: [
                        { value: "1", label: "Walking from check to counter", correct: true },
                        { value: "2", label: "The cashier scanning the card", correct: false }
                    ]
                },
                {
                    text: "What breaks the system's assumption in the analogy?",
                    options: [
                        { value: "1", label: "Another person redeeming the reward in between", correct: true },
                        { value: "2", label: "The card design", correct: false }
                    ]
                }
            ]
        });
        </script>
    </div>
</section>