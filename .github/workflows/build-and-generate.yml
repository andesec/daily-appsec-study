name: Build Lessons & Generate Homepage

on:
    push:
        branches: [main]
    pull_request:

permissions:
    contents: write

jobs:
    # ------------------------
    # 1. BUILD LESSONS (RUNS FIRST)
    # ------------------------
    build-lessons:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Build lesson HTML files
              run: python join_html_topics.py

            - name: Commit updated lesson HTML files
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add lessons/*.html
                  if ! git diff --cached --quiet; then
                    git commit -m "Auto-build lesson HTML"
                    git push
                  else
                    echo "No changes to commit."
                  fi

    # ------------------------
    # 2. GENERATE HOMEPAGE (RUNS SECOND)
    # ------------------------
    generate-homepage:
        needs: build-lessons # <-- THIS enforces correct order
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Generate index.html
              run: |
                  echo "<!DOCTYPE html>" > index.html
                  echo "<html><head><meta charset='UTF-8'><title>Index</title>" >> index.html
                  echo "<style>
                          body { font-family: sans-serif; padding: 20px; }
                          ul { list-style: none; padding: 0; }
                          li { margin: 12px 0; }
                          a {
                            display: block;
                            padding: 14px 18px;
                            background: #f4f4f4;
                            border-radius: 8px;
                            text-decoration: none;
                            color: #333;
                            font-size: 18px;
                          }
                          a:hover {
                            background: #e0e0e0;
                          }
                        </style></head><body>" >> index.html
                  echo "<h1>Available Lessons</h1>" >> index.html
                  echo "<ul>" >> index.html

                  for file in $(ls lessons/*.html 2>/dev/null | sort); do
                    clean=${file#lessons/}
                    name=${clean%.html}
                    echo "<li><a href=\"$file\">$name</a></li>" >> index.html
                  done

                  echo "</ul></body></html>" >> index.html

            - name: Commit updated index.html
              run: |
                  git config user.name "github-actions"
                  git config user.email "actions@github.com"
                  git add index.html
                  git commit -m "Auto-generate homepage" || echo "No changes to commit"
                  git push
